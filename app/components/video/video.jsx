"use client";
import React, {
  useCallback,
  useContext,
  useEffect,
  useMemo,
  useRef,
  useState,
  useLayoutEffect
} from "react";
import { EVENTS } from "../../../helpers/events";
import { SocketContext } from "../socket";
import { Popover } from "react-tiny-popover";
import _debounce from "lodash/debounce";
import { Tooltip } from "react-tippy";
import { FFmpeg } from "@ffmpeg/ffmpeg";
import { fetchFile } from "@ffmpeg/util";
import {
  MicOff,
  PauseCircle,
  Phone,
  PlayCircle,
  ExternalLink,
  Play,
  Pause,
  Aperture,
  FilePlus,
  X,
  Trash2,
  Crop,
  Video,
  VideoOff,
} from "react-feather";
import { AccountType, SHAPES } from "../../common/constants";
import { CanvasMenuBar } from "./canvas.menubar";
import { toast } from "react-toastify";
import { max, set } from "lodash";
import { Button, Modal, ModalBody, ModalFooter, ModalHeader } from "reactstrap";
import html2canvas from "html2canvas";
import CustomModal from "../../common/modal";
import CropImage from "./cropimage";
import jsPDF from "jspdf";
import { getS3SignPdfUrl } from "./video.api";
import axios from "axios";
import {
  createReport,
  cropImage,
  getReport,
  getS3SignUrl,
  getSaveSessionS3SignUrl,
  removeImage,
  screenShotTake,
} from "../videoupload/videoupload.api";
import ReportModal from "./reportModal";
import { Utils } from "../../../utils/utils";
import { awsS3Url } from "../../../utils/constant";
import ScreenShotDetails from "./screenshotDetails";
import { FaLock, FaUnlock } from "react-icons/fa";
import { useMediaQuery } from "../../hook/useMediaQuery";
import PermissionModal from "./PermissionModal";
import { getInitials } from "../../../utils/videoCall";
import Timer from "./Timer";
import { isMobile } from 'react-device-detect';
import OrientationModal from "../modalComponent/OrientationModal";
import MobileDetect from 'mobile-detect';
import { isIOS } from 'react-device-detect';
import Script from 'next/script'
import LazyVideo from "./LazyVideo";
import { traineeClips } from "../../../containers/rightSidebar/fileSection.api";
import { fetchPeerConfig } from "../../../api";
import { bookingsState } from "../common/common.slice";
import { useAppSelector } from "../../store";

let storedLocalDrawPaths = { sender: [], receiver: [] };
let selectedShape = null;
let canvasConfigs = {
  sender: {
    strokeStyle: "red",
    lineWidth: 5,
    lineCap: "round",
  },
  receiver: {
    strokeStyle: "green",
    lineWidth: 5,
    lineCap: "round",
  },
};

// default setup;
let isDrawing = false;
let savedPos;
let startPos;
let currPos;
let strikes = [];
let extraStream;
let localVideoRef;
let Peer;
export const HandleVideoCall = ({
  id,
  accountType,
  fromUser,
  toUser,
  isClose,
  session_end_time,
  bIndex,
}) => {

  //  console.log(toUser , fromUser , 'toUserFromUser')
  // const dispatch = useAppDispatch();
  const socket = useContext(SocketContext);
  const [sketchPickerColor, setSketchPickerColor] = useState({
    r: 241,
    g: 112,
    b: 19,
    a: 1,
  });
  const { startMeeting  } = useAppSelector(bookingsState);

  const [remoteStream, setRemoteStream] = useState(null);
  const [localStream, setLocalStream] = useState(null);
  const ffmpegRef = useRef(new FFmpeg());

  const [isMuted, setIsMuted] = useState(false);
  const [isFeedStopped, setIsFeedStopped] = useState(false);
  const [displayMsg, setDisplayMsg] = useState({ showMsg: false, msg: "" });
  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const state = {
    mousedown: false,
  };
  const [selectedClips, setSelectedClips] = useState([]);

  // console.log("selectedClips============>", selectedClips)

  const selectedVideoRef1 = useRef(null);
  const selectedVideoRef2 = useRef(null);
  const progressBarRef = useRef(null);
  const progressBarRef2 = useRef(null);
  const globalProgressBarRef = useRef(0);
  const [progressRange, setProgressRange] = useState(0);
  const [isRemoteVideoOff, setRemoteVideoOff] = useState(false);
  const [isPlaying, setIsPlaying] = useState({
    isPlayingAll: false,
    number: "",
    isPlaying1: false,
    isPlaying2: false,
  });
  const [videoTime, setVideoTime] = useState({
    currentTime1: "00:00",
    currentTime2: "00:00",
    remainingTime1: "00:00",
    remainingTime2: "00:00",
  });
  const [maxMin, setMaxMin] = useState(false);
  const [isOpen, setIsOpen] = useState(false);
  const [isOpenConfirm, setIsOpenConfirm] = useState(false);
  const remoteVideoRef = useRef(null);
  const peerRef = useRef(null);
  const [isOpenReport, setIsOpenReport] = useState(false);
  const [isOpenCrop, setIsOpenCrop] = useState(false);
  const [screenShots, setScreenShots] = useState([]);
  const [reportObj, setReportObj] = useState({ title: "", topic: "" });
  const [reportArr, setReportArr] = useState([]);
  const [selectImage, setSelectImage] = useState(0);
  const [volume, setVolume] = useState(1);
  const [volume2, setVolume2] = useState(1);

  const volumeInputRef = useRef(null);
  const volumeInputRef2 = useRef(null);

  const [recording, setRecording] = useState(false);
  const [mediaRecorder, setMediaRecorder] = useState(null);
  const [recordedChunks, setRecordedChunks] = useState([]);
  // const [screenStream, setScreenStream] = useState(null);

  const [timeRemaining, setTimeRemaining] = useState(0);
  const [timeoutReached, setTimeoutReached] = useState(false);
  // const [timeDifference, setTimeDifference] = useState("");
  const [screenStream, setScreenStream] = useState(null);

  const [isCallEnded, setIsCallEnded] = useState(false);
  const [micStream, setMicStream] = useState(null);

  const [isModelOpen, setIsModelOpen] = useState(false);
  const [isScreenShotModelOpen, setIsScreenShotModelOpen] = useState(false);

  const [isPinned, setIsPinned] = useState(false);
  const [pinnedUser, setPinnedUser] = useState(null);
  const [videoController, setVideoController] = useState(false);
  const [isTraineeJoined, setIsTraineeJoined] = useState(false);
  const [isCanvasMenuNoteShow, setIsCanvasMenuNoteShow] = useState(false);
  const [micNote, setMicNote] = useState(false);
  const [clipSelectNote, setClipSelectNote] = useState(false);
  const [countClipNoteOpen, setCountClipNoteOpen] = useState(false);
  const [callEnd, setCallEnd] = useState(false);
  const [permissionModal, setPermissionModal] = useState(true);
  const width500 = useMediaQuery(500);
  const width768 = useMediaQuery(768);
  const width900 = useMediaQuery(900);
  const width1000 = useMediaQuery(1000);

  const [isTooltipShow, setIsTooltipShow] = useState(true);
  const [modal, setModal] = useState(false);
  const [showThumbnailForFirstVideo, setShowThumbnailForFirstVideo] = useState(true);
  const [showThumbnailForTwoVideo, setShowThumbnailForTwoVideo] = useState(true);
  const timeDifference = Timer(session_end_time);
  const errorHandling = (err) => toast.error(err)



  /**
   * In feature if crossOrigin="anonymous" is requre Future considerations.
   * If you plan to implement features that involve manipulating video data (e.g., capturing frames, applying filters), you might need to re-enable crossOrigin.
   * If you move your video hosting to a different domain in the future, you might need to reconsider CORS settings.
   */

  // const needsCrossOrigin = videoUrl.startsWith('https://different-domain.com');

  let height = window.innerHeight;


  function setInitialPinnedUser() {
    if (height < 500) {
      setIsPinned(true)
      if (accountType === AccountType.TRAINER) {
        setPinnedUser("user-video-1")
      } else {
        setPinnedUser("user-video-2")
      }
    }
  }

  function resetInitialPinnedUser() {
    if (height < 500) {
      setIsPinned(false);
      setPinnedUser(null);
    }
  }

  // selects trainee clips on load
  async function selectTraineeClip (setter){
    console.log('selected Trainee clips called , ' , startMeeting)
    try{
        if(startMeeting?.trainee_clip?.length > 0){
          setter(startMeeting.trainee_clip)
        }else{
          setter([])
        }
    }catch(err){
        console.log(err)
    }
}
useEffect(() =>{
  if(toUser.account_type === "Trainee" && isTraineeJoined){
    selectTraineeClip(setSelectedClips);
  }
},[isTraineeJoined])

  useEffect(() => {
    setInitialPinnedUser()
  }, [])

useEffect(() => {
  const canvas = document.getElementById('drawing-canvas');

    // Only apply the warning if the canvas element exists
  if (canvas) {
    const handleBeforeUnload = (event) => {
      event.preventDefault();
        event.returnValue = 'You are currently in a call. Are you sure you want to leave or reload? This will disconnect the call.';
      };

      // Attach the event listener for beforeunload
    window.addEventListener('beforeunload', handleBeforeUnload);

      // Cleanup the event listener when the component unmounts
    return () => {
      window.removeEventListener('beforeunload', handleBeforeUnload);
    };
  }
  }, []); // Empty dependency array to run only once when component mounts

  // console.log("=========",height,  height < 500, {pinnedUser, isPinned})
  useLayoutEffect(() => {
    const updateOrientation = () => {
      let width = window.innerWidth;
      let height = window.innerHeight;
      if (width > height == false) {
        // console.log("=========if block")
        setModal(true)
      } else {
        // console.log("=========else block")
        setModal(false)
      }
    };

    const handleOrientationChange = () => {
      updateOrientation();
    };

    // Add event listener for orientation change
    window.addEventListener('resize', handleOrientationChange);

    // Call updateOrientation once initially
    updateOrientation();

    // Clean up the event listener when the component unmounts
    return () => {
      window.removeEventListener('resize', handleOrientationChange);
    };
  }, [isMobile]);

  // NOTE - handle Tab Close
  const handelTabClose = async () => {
    mediaRecorder?.stop();
    setRecording(false);
    socket.emit("chunksCompleted");
  };

  const startRecording = async () => {
    setRecording(true);

    const data = {
      sessions: id,
      trainer: toUser?._id,
      trainee: fromUser?._id,
      user_id: fromUser?._id,
      trainee_name: fromUser?.fullname,
      trainer_name: toUser?.fullname,
    };

    socket.emit("videoUploadData", data);

    const mixedAudioStream = await setupAudioMixing();

    const screenStr = await navigator.mediaDevices.getDisplayMedia({
      video: true,
      preferCurrentTab: true,
    });
    setScreenStream(screenStr);

    const screenVideoTrack = screenStr.getVideoTracks()[0];

    const combinedStream = new MediaStream([
      screenVideoTrack,
      ...mixedAudioStream.getAudioTracks(),
    ]);

    const mediaRecorder = new MediaRecorder(combinedStream);

    let chunks = [];

    mediaRecorder.ondataavailable = (event) => {
      if (event.data.size > 0) {
        chunks.push(event.data);
      }
    };
    setInterval(function () {
      // Check if the MediaRecorder is recording
      if (mediaRecorder.state === "recording") {
        // Request data if available
        mediaRecorder.requestData();

        const chunkBuffers = chunks
          .map((chunk) => {
            // Assuming chunk is already a Buffer or Uint8Array, no conversion needed
            if (chunk) {
              // console.log("Chunk type:", typeof chunk);
              return chunk;
            } else {
              // Handle invalid chunk data here
              // console.log("Invalid chunk data:", chunk);
              return null; // or handle differently as needed
            }
          })
          .filter(Boolean); // Remove null entries

        // Send only if there are valid chunkBuffers
        if (chunkBuffers.length > 0) {
          const chunkData = { data: chunkBuffers };
          socket.emit("chunk", chunkData);
          // Handle the recorded data here (in chunks array)
          // console.log("Data:", chunkBuffers);
        } else {
          // console.log("No valid chunks to send");
        }

        // Clear chunks array for next interval
        chunks = [];
      }
    }, 1000);

    mediaRecorder.onstop = () => {
      // const blob = new Blob(chunks, { type: "video/webm" });
      // const url = URL.createObjectURL(blob);
      // const a = document.createElement("a");
      // document.body.appendChild(a);
      // a.style = "display: none";
      // a.href = url;
      // a.download = `${Date.now()}.webm`;
      // a.click();
      // window.URL.revokeObjectURL(url);
      socket.emit("chunksCompleted");
    };

    mediaRecorder.start();
    setMediaRecorder(mediaRecorder);
  };

  const stopRecording = () => {
    if (mediaRecorder) {
      mediaRecorder.stop();
      setRecording(false);
    }
    if (screenStream) {
      screenStream.getTracks().forEach((track) => track.stop());
      setScreenStream(null);
    }
  };

  // NOTE - handle user offline
  const handleOffline = () => {
    stopRecording();
    socket.emit("chunksCompleted");
  };

  // NOTE - Start call

  const handleStartCall = async () => {
    try {
      // Request access to media devices
      const stream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true,
      });

      // console.log("Media stream obtained:", stream);

      // Update state and UI
      setPermissionModal(false);
      setLocalStream(stream);
      setDisplayMsg({
        showMsg: true,
        msg: `Waiting for ${toUser?.fullname} to join...`,
      });

      // Assign stream to video element
      videoRef.current.srcObject = stream;

      // Create a new Peer instance
      // const peer = new Peer(fromUser._id, {
      //   config: {
      //     iceServers: [
      //       {
      //         username: "netqwixSTURN",
      //         credential: "testing@123",
      //         url: "turn:turn.netqwix.com",
      //       },
      //     ],
      //   },
      // });
      
      const peer = new Peer(fromUser._id, {
        config: startMeeting.iceServers
      });
      peerRef.current = peer;
      
      // Handle Peer events
      peer.on("open", (id) => {
        // console.log("Peer connection opened with ID:", id);
        socket.emit("ON_CALL_JOIN", {
          userInfo: { from_user: fromUser._id, to_user: toUser._id },
        });
        console.log('call joined')
      });

      peer.on("error", (error) => {
        // console.error("Peer error:", error);
      });

      peer.on("call", (call) => {
        // console.log("Incoming call received:", call);
        call.answer(stream);
        call.on("stream", (remoteStream) => {
          // console.log("Remote stream received:", remoteStream);
          setIsTraineeJoined(true);
          setDisplayMsg({ showMsg: false, msg: "" });
          setRemoteStream(remoteStream);
        });
      });

      // console.log("Call setup complete.");
    } catch (err) {
      // console.error("Media permission error:", err);
      setPermissionModal(true);
      errorHandling("Please allow media permission to microphone and camera for video call...");
    }
  };

  //NOTE -  Initiate outgoing connection
  let connectToPeer = (peer, peerId) => {
    // console.log(`Connecting to ${peerId}...`);

    // let conn = peer.connect(peerId);
    // conn.on('data', (data) => {
    //     console.log(`received: ${data}`);
    // });
    // conn.on('open', () => {
    //     conn.send('hi!');
    // });

    // navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    // .then((stream) => {
    if (!(videoRef && videoRef?.current)) return;
    let call = peer.call(peerId, videoRef?.current?.srcObject);
    call.on("stream", (remoteStream) => {
      // console.log(`setting remoteStream for 2nd user here ---- `);
      setDisplayMsg({ showMsg: false, msg: "" });
      setIsTraineeJoined(true);
      remoteVideoRef.current.srcObject = remoteStream;
      setRemoteStream(remoteStream);
      accountType === AccountType.TRAINEE ? setIsModelOpen(true) : null;
    });
    // })
    // .catch((err) => {
    //     console.log('Failed to get local stream', err);
    // });
  };

  const initializeLocalStates = () => {
    strikes = [];
    localVideoRef = null;
    selectedShape = null;
  };

  const listenSocketEvents = () => {
    // once user joins the call
    socket.on("ON_CALL_JOIN", ({ userInfo }) => {
      // console.log(
      //   ` end user join --- `,
      //   userInfo,
      //   peerRef.current,
      //   fromUser,
      //   toUser
      // );
      const { to_user, from_user } = userInfo;
      if (!(peerRef && peerRef.current)) return;
      connectToPeer(peerRef.current, from_user);
    });

    // Handle signaling events from the signaling server
    socket.on(EVENTS.VIDEO_CALL.ON_OFFER, (offer) => {
      // console.log(` -- on OFFER --`);
      peerRef.current?.signal(offer);
    });

    socket.on(EVENTS.VIDEO_CALL.ON_ANSWER, (answer) => {
      // console.log(` -- on answer --`);
      peerRef.current?.signal(answer);
    });

    socket.on(EVENTS.VIDEO_CALL.ON_ICE_CANDIDATE, (candidate) => {
      // console.log(` -- on ICE candidate --`);
      peerRef.current?.signal(candidate);
    });

    socket.on(EVENTS.ON_CLEAR_CANVAS, () => {
      clearCanvas();
    });

    // socket.on(EVENTS.VIDEO_CALL.MUTE_ME, ({ muteStatus }) => {
    //   if (remoteVideoRef.current && remoteVideoRef.current.srcObject) {
    //     remoteVideoRef.current.srcObject.getAudioTracks()[0].enabled =
    //       muteStatus;
    //   }
    // });

    socket.on(EVENTS.VIDEO_CALL.STOP_FEED, ({ feedStatus }) => {
      setRemoteVideoOff(feedStatus);

      // if (remoteVideoRef.current && remoteVideoRef.current.srcObject) {
      //   remoteVideoRef.current.srcObject.getVideoTracks()[0].enabled =
      //     feedStatus;
      //   console.log("====================================");
      //   console.log(feedStatus, "feedStatus");
      //   console.log("====================================");
      //   setRemoteVideoOff(feedStatus);
      // } else {
      //   // remoteVideoRef.current.srcObject.getVideoTracks()[0].enabled = feedStatus;
      // }
    });

    socket.on(EVENTS.EMIT_DRAWING_CORDS, ({ strikes, canvasSize }) => {
      const canvas = canvasRef.current;
      const context = canvas?.getContext("2d");
      if (!context || !canvas) return;
      const blob = new Blob([strikes]);
      const image = new Image();
      image.src = URL.createObjectURL(blob);
      image.onload = () => {
        const { width, height } = canvasSize;
        const scaleX = canvas.width / width;
        const scaleY = canvas.height / height;
        context.clearRect(0, 0, canvas.width, canvas.height);
        context.drawImage(image, 0, 0, width * scaleX, height * scaleY);
      };
    });

    socket.on(EVENTS.ON_UNDO, ({ sender, receiver }) => {
      storedLocalDrawPaths.receiver = [];
      storedLocalDrawPaths.sender = [];
      storedLocalDrawPaths.sender = receiver;
      storedLocalDrawPaths.receiver = sender;
      undoDrawing(
        { coordinates: sender, theme: canvasConfigs.receiver },
        {
          coordinates: receiver,
          theme: {
            lineWidth: canvasConfigs.sender.lineWidth,
            strokeStyle: canvasConfigs.sender.strokeStyle,
          },
        },
        false
      );
    });

    socket.on(EVENTS.VIDEO_CALL.ON_CLOSE, () => {
      setDisplayMsg({
        showMsg: true,
        msg: `${toUser?.fullname} left the meeting, redirecting back to home screen in 5 seconds...`,
      });
      cleanupFunction();
    });
  };

  

  const adjustCanvasSize = () => {
    const canvas = canvasRef.current;
    if (canvas) {
      const ratio = window.devicePixelRatio || 1;
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      const context = canvas.getContext('2d');
      context.scale(ratio, ratio);
    }
  };

  useEffect(() => {
    // adjustCanvasSize();
    const sidebar = document.getElementById("left-nav-wrapper")
    let getNavbarTabs = document.getElementById("get-navbar-tabs");
    if(sidebar){
      sidebar.style.display="none"
      getNavbarTabs.style.marginLeft = '25px';
        getNavbarTabs?.style?.setProperty('width', 'calc(100vw - 25px)');
    }
    console.log("sidebar",sidebar)
    return ()=>{
      if(sidebar){
        sidebar.style.display="block"
        getNavbarTabs.style.marginLeft ='105px';
        getNavbarTabs?.style?.setProperty('width','calc(100vw - 70px)');
      }
    }
    // window.addEventListener('resize', adjustCanvasSize);
    // return () => window.removeEventListener('resize', adjustCanvasSize);
  }, []);

  // NOTE - call end
  const cutCall = () => {
    // console.log(`--- cut call --- `);
    stopRecording();
    cleanupFunction();
    if (isTraineeJoined && AccountType.TRAINER === accountType) {
      setIsOpenReport(true);
    } else {
      isClose();
    }
    // if (remoteVideoRef && remoteVideoRef.current) {
    //   socket.emit(EVENTS.VIDEO_CALL.ON_CLOSE, {
    //     userInfo: { from_user: fromUser._id, to_user: toUser._id },
    //   });
    // }
  };

  // // NOTE - stop streaming after getting call end
  // useEffect(() => {
  //   if (screenStream) {
  //     screenStream.getVideoTracks().forEach((track) => {
  //       track.stop();
  //     });
  //   }
  //   if (localStream) {
  //     localStream.getVideoTracks().forEach((track) => {
  //       track.stop();
  //     });
  //   }
  //   if (micStream) {
  //     micStream.getAudioTracks().forEach((track) => {
  //       track.stop();
  //     });
  //   }
  //   stopRecording();
  // }, [isCallEnded]);

  useEffect(() => {
    if (fromUser && toUser) {
      if (typeof navigator !== "undefined") {
        Peer = require("peerjs").default;
      }
      handleStartCall();
      listenSocketEvents();
      initializeLocalStates();
      window.addEventListener("offline", handleOffline);
      window.addEventListener("beforeunload", handelTabClose);

      return () => {
        window.removeEventListener("beforeunload", handelTabClose);
        window.removeEventListener("offline", handleOffline);
        cutCall();
      };
    }
  }, []);

  // NOTE -  end user video stream
  useMemo(() => {
    if (
      remoteVideoRef.current &&
      remoteStream &&
      !remoteVideoRef.current.srcObject
    ) {
      remoteVideoRef.current.srcObject = remoteStream;
      accountType === AccountType.TRAINEE ? setIsModelOpen(true) : null;
    
    }

    return () => {
      cutCall();
    };
  }, [remoteStream]);

  // NOTE - if trainer is joined before trainee and trainer's video has been pause then emit the even to trainee
  useEffect(() => {
    if (isTraineeJoined) {
      socket.emit(EVENTS.VIDEO_CALL.STOP_FEED, {
        userInfo: { from_user: fromUser._id, to_user: toUser._id },
        feedStatus: isFeedStopped,
      });
    }
  }, [isTraineeJoined])


  const setupAudioMixing = async () => {
    const audioContext = new AudioContext();

    // Get the local audio track from the localStream
    const localAudioStream = await navigator.mediaDevices.getUserMedia({
      audio: true,
    });
    setMicStream(localAudioStream); // Assuming setMicStream is a function defined elsewhere
    const localAudioTrack = localAudioStream.getAudioTracks()[0];

    // Check if remoteStream exists and has audio tracks before accessing
    let remoteAudioTrack;
    if (remoteStream && remoteStream.getAudioTracks().length > 0) {
      remoteAudioTrack = remoteStream.getAudioTracks()[0];
    } else {
      // Handle the case where remoteStream is null or has no audio tracks
      // This might involve logging an error, setting a default track, or some other fallback
      // console.error("remoteStream is null or has no audio tracks.");
      // Optionally, return or continue with additional logic here
      // For example, you might want to only process local audio if remote audio is unavailable
    }

    // Create audio nodes for the local audio track. If remoteAudioTrack is undefined,
    // skip creating or connecting the remote source to avoid errors.
    const localSource = audioContext.createMediaStreamSource(
      new MediaStream([localAudioTrack])
    );
    const destination = audioContext.createMediaStreamDestination();
    localSource.connect(destination);

    if (remoteAudioTrack) {
      // Create and connect the audio node for the remote audio track only if it exists
      const remoteSource = audioContext.createMediaStreamSource(
        new MediaStream([remoteAudioTrack])
      );
      remoteSource.connect(destination);
    }

    // Return the mixed audio stream from the destination
    return destination.stream;
  };


  useEffect(() => {
    const video = videoRef.current;
    const canvas = canvasRef.current;
    const context = canvas?.getContext("2d");
    if (!context) return;

    const drawFrame = () => {
      if (canvas && context && video) {
        //   context.drawImage(video, 0, 0, canvas.width, canvas.height);
        context.fillStyle = "rgba(255, 255, 255, 0.5)";
        context.fillRect(0, 0, canvas.width, canvas.height);
      }
      requestAnimationFrame(drawFrame);
    };

    const startDrawing = (event) => {
      event.preventDefault();
        isDrawing = true;
        if (!context) return;
        savedPos = context?.getImageData(
          0,
          0,
          document.getElementById("bookings")?.clientWidth,
          document.getElementById("bookings")?.clientHeight
        );
        if (strikes.length >= 10) strikes.shift(); // removing first position if strikes > 10;
        strikes.push(savedPos);
        // const mousePos = getMosuePositionOnCanvas(event);
        const mousePos = event.type.includes('touchstart') ? getTouchPos(event) : getMosuePositionOnCanvas(event);
        console.log('...mousePos...', mousePos)
        context.strokeStyle = canvasConfigs.sender.strokeStyle;
        context.lineWidth = canvasConfigs.sender.lineWidth;
        context.lineCap = "round";
        context.beginPath();
        context.moveTo(mousePos.x, mousePos.y);
        context.fill();
        state.mousedown = true;
        startPos = { x: mousePos.x, y: mousePos.y };
    };

    const findDistance = () => {
      let dis = Math.sqrt(
        Math.pow(currPos.x - startPos.x, 2) +
        Math.pow(currPos.y - startPos.y, 2)
      );
      return dis;
    };

    const drawShapes = () => {
      switch (selectedShape) {
        case SHAPES.LINE: {
          context.moveTo(startPos.x, startPos.y);
          context.lineTo(currPos.x, currPos.y);
          break;
        }
        case SHAPES.CIRCLE: {
          let distance = findDistance(startPos, currPos);
          context.arc(startPos.x, startPos.y, distance, 0, 2 * Math.PI, false);
          break;
        }
        case SHAPES.SQUARE: {
          let w = currPos.x - startPos.x;
          let h = currPos.y - startPos.y;
          context.rect(startPos.x, startPos.y, w, h);
          break;
        }
        case SHAPES.RECTANGLE: {
          let w = currPos.x - startPos.x;
          let h = currPos.y - startPos.y;
          context.rect(startPos.x, startPos.y, w, h);
          break;
        }
        case SHAPES.OVAL: {
          const transform = context.getTransform();
          let w = currPos.x - startPos.x;
          let h = currPos.y - startPos.y;
          context.fillStyle = "#FFFFFF";
          context.fillStyle = "rgba(0, 0, 0, 0)";
          const radiusX = w * transform.a;
          const radiusY = h * transform.d;
          if (radiusX > 0 && radiusY > 0) {
            context.ellipse(
              currPos.x,
              currPos.y,
              radiusX,
              radiusY,
              0,
              0,
              2 * Math.PI
            );
            context.fill();
          }
          break;
        }
        case SHAPES.TRIANGLE: {
          context.moveTo(startPos.x + (currPos.x - startPos.x) / 2, startPos.y);
          context.lineTo(startPos.x, currPos.y);
          context.lineTo(currPos.x, currPos.y);
          context.closePath();
          break;
        }
        case SHAPES.ARROW_RIGHT: {
          const arrowSize = 10;
          const direction = Math.atan2(
            currPos.y - startPos.y,
            currPos.x - startPos.x
          );
          // Calculate the coordinates of the arrowhead
          const arrowheadX = currPos.x + length * Math.cos(direction);
          const arrowheadY = currPos.y + length * Math.sin(direction);
          // Draw the line of the arrow
          context.moveTo(startPos.x, startPos.y);
          context.lineTo(currPos.x, currPos.y);
          // Draw the arrowhead
          context.moveTo(arrowheadX, arrowheadY);
          context.lineTo(
            currPos.x - arrowSize * Math.cos(direction - Math.PI / 6),
            currPos.y - arrowSize * Math.sin(direction - Math.PI / 6)
          );
          context.moveTo(currPos.x, currPos.y);
          context.lineTo(
            currPos.x - arrowSize * Math.cos(direction + Math.PI / 6),
            currPos.y - arrowSize * Math.sin(direction + Math.PI / 6)
          );
          context.stroke();
          break;
        }
        case SHAPES.TWO_SIDE_ARROW: {
          const x1 = startPos.x;
          const y1 = startPos.y;
          const x2 = currPos.x;
          const y2 = currPos.y;
          const size = 10;
          const angle = Math.atan2(y2 - y1, x2 - x1);
          const arrowPoints = [
            {
              x: x2 - size * Math.cos(angle - Math.PI / 6),
              y: y2 - size * Math.sin(angle - Math.PI / 6),
            },
            {
              x: x2 - size * Math.cos(angle + Math.PI / 6),
              y: y2 - size * Math.sin(angle + Math.PI / 6),
            },
            {
              x: x1 + size * Math.cos(angle - Math.PI / 6),
              y: y1 + size * Math.sin(angle - Math.PI / 6),
            },
            {
              x: x1 + size * Math.cos(angle + Math.PI / 6),
              y: y1 + size * Math.sin(angle + Math.PI / 6),
            },
          ];
          context.moveTo(x1, y1);
          context.lineTo(x2, y2);
          context.moveTo(arrowPoints[0].x, arrowPoints[0].y);
          context.lineTo(x2, y2);
          context.lineTo(arrowPoints[1].x, arrowPoints[1].y);
          context.moveTo(arrowPoints[2].x, arrowPoints[2].y);
          context.lineTo(x1, y1);
          context.lineTo(arrowPoints[3].x, arrowPoints[3].y);

          context.stroke();
          break;
        }
      }
    };

    const draw = (event) => {
      event.preventDefault();
      if (!isDrawing || !context || !state.mousedown) return;
      // const mousePos = getMosuePositionOnCanvas(event);
      const mousePos = event.type.includes('touchmove') ? getTouchPos(event) : getMosuePositionOnCanvas(event);
      currPos = { x: mousePos?.x, y: mousePos.y };

      if (selectedShape !== SHAPES.FREE_HAND) {
        context.putImageData(savedPos, 0, 0);
        context.beginPath();
        drawShapes();
        context.stroke();
      } else {
        // console.log(`--- drawing ---- `);
        context.strokeStyle = canvasConfigs.sender.strokeStyle;
        context.lineWidth = canvasConfigs.sender.lineWidth;
        context.lineCap = "round";
        context.lineTo(mousePos.x, mousePos.y);
        context.stroke();
      }
    };

    const stopDrawing = (event) => {
      event.preventDefault();
      if (state.mousedown) {
        // console.log(`--- stop drawing ---- `);
        sendStopDrawingEvent();
        isDrawing = false;
        state.mousedown = false;
        sendDrawEvent();
      }
    };

    // allowing trainer to draw
    if (canvas && accountType === AccountType.TRAINER) {
      // for mobile
      canvas.addEventListener("touchstart", startDrawing, { passive: false });
      canvas.addEventListener("touchmove", draw, { passive: false });
      canvas.addEventListener("touchend", stopDrawing, { passive: false });
      // canvas.addEventListener("touchcancel", stopDrawing, { passive: false });
      // for web
      canvas.addEventListener("mousedown", startDrawing);
      canvas.addEventListener("mousemove", draw);
      canvas.addEventListener("mouseup", stopDrawing);
      // canvas.addEventListener("mouseout", stopDrawing);
    }

    return () => {
      video?.removeEventListener("play", drawFrame);
      cutCall();
    };
  }, [canvasRef]);

  const getMosuePositionOnCanvas = (event) => {
    const canvas = canvasRef.current;
    var rect = canvas.getBoundingClientRect();
    var x = event?.clientX - rect?.left;
    var y = event?.clientY - rect?.top;
    return {
      x: x || 0,
      y: y || 0,
    };

    // if (
    //   event.clientX ||
    //   event.clientY ||
    //   (event?.touches && event?.touches[0])
    // ) {
    //   const clientX = event?.clientX || event?.touches[0]?.clientX;
    //   const clientY = event?.clientY || event?.touches[0]?.clientY;
    //   const { offsetLeft, offsetTop } = event.target;
    //   const canvasX = clientX - (offsetLeft || (mediaQuery.matches ? 100 : 50));
    //   const canvasY = clientY - offsetTop;
    // }
  };

  const getTouchPos = (touchEvent) => {
    const canvas = canvasRef.current;
    var rect = canvas.getBoundingClientRect();
    var x = touchEvent?.changedTouches[0]?.clientX - rect?.left;
    var y = touchEvent?.changedTouches[0]?.clientY - rect?.top;
    return {
      x: x || 0,
      y: y || 0,
    };
  };


  const clearCanvas = () => {
    const canvas = canvasRef.current;
    const context = canvas?.getContext("2d");
    if (!context || !canvas) return;
    context.clearRect(0, 0, canvas.width, canvas.height);
  };

  const sendDrawEvent = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const { width, height } = canvas;

    canvas.toBlob((blob) => {
      const reader = new FileReader();
      reader.onload = (event) => {
        if (!(event && event.target)) return;
        const binaryData = event.target.result;
        // console.log(`emit draw event---`);
        socket.emit(EVENTS.DRAW, {
          userInfo: { from_user: fromUser._id, to_user: toUser._id },
          // storedEvents,
          // canvasConfigs,
          strikes: binaryData,
          canvasSize: { width, height }
        });
      };
      reader.readAsArrayBuffer(blob);
    });
  };

  const sendStopDrawingEvent = () => {
    if (remoteVideoRef && remoteVideoRef.current) {
      socket.emit(EVENTS.STOP_DRAWING, {
        userInfo: { from_user: fromUser._id, to_user: toUser._id },
      });
    }
  };

  const sendClearCanvasEvent = () => {
    if (remoteVideoRef && remoteVideoRef.current) {
      socket.emit(EVENTS.EMIT_CLEAR_CANVAS, {
        userInfo: { from_user: fromUser._id, to_user: toUser._id },
      });
    }
  };

  function handlePeerDisconnect() {
    stopRecording();
    if (!(peerRef && peerRef.current)) return;
    //NOTE -  manually close the peer connections
    for (let conns in peerRef.current.connections) {
      peerRef.current.connections[conns].forEach((conn, index, array) => {
        // console.log(
        //   `closing ${conn.connectionId} peerConnection (${index + 1}/${array.length
        //   })`,
        //   conn.peerConnection
        // );
        conn.peerConnection.close();

        //NOTE - close it using peerjs methods
        if (conn.close) conn.close();
      });
    }
  }

  const cleanupFunction = () => {
    handlePeerDisconnect();
    setIsCallEnded(true);

    if (localStream) {
      localStream.getAudioTracks().forEach(function (track) {
        track.stop();
      });
      localStream.getVideoTracks().forEach((track) => {
        track.stop();
      });
      setLocalStream(null);
    }
    if (screenStream) {
      screenStream.getAudioTracks().forEach(function (track) {
        track.stop();
      });
      screenStream.getVideoTracks().forEach((track) => {
        track.stop();
      });
      setScreenStream(null);
    }

    if (remoteStream) {
      remoteStream.getAudioTracks().forEach(function (track) {
        track.stop();
      });
      setRemoteStream(null);
    }
    if (micStream) {
      micStream.getAudioTracks().forEach((track) => {
        track.stop();
      });
    }
    let videorefSrc = videoRef.current || localVideoRef;
    if (videoRef && videorefSrc && videorefSrc.srcObject) {
      videorefSrc.srcObject.getTracks().forEach((t) => {
        t.stop();
      });

      videorefSrc.srcObject.getVideoTracks().forEach((t) => {
        t.stop();
      });
    }

    let videorefSrcRemote = remoteVideoRef.current;
    if (remoteVideoRef && videorefSrcRemote && videorefSrcRemote.srcObject) {
      videorefSrcRemote.srcObject.getTracks().forEach((t) => {
        t.stop();
      });
      videorefSrcRemote.srcObject.getVideoTracks().forEach((t) => {
        t.stop();
      });
    }

    if (peerRef.current) {
      peerRef.current.destroy();
      peerRef.current = null;
    }

    clearCanvas();
  };

  const sendEmitUndoEvent = useCallback(_debounce(sendDrawEvent, 500), []);

  const undoDrawing = async (
    senderConfig,
    extraCoordinateConfig,
    removeLastCoordinate = true
  ) => {
    const canvas = canvasRef.current;
    const context = canvas?.getContext("2d");
    if (!context || !canvas) return;
    context.clearRect(0, 0, canvas.width, canvas.height);
    if (removeLastCoordinate) storedLocalDrawPaths.sender.splice(-1, 1);
    // draw all the paths in the paths array
    await senderConfig.coordinates.forEach((path) => {
      context.beginPath();
      context.strokeStyle = senderConfig.theme.strokeStyle;
      context.lineWidth = senderConfig.theme.lineWidth;
      context.lineCap = "round";
      if (path && Array.isArray(path)) {
        // context.
        context.moveTo(path[0][0], path[0][1]);
        for (let i = 0; i < path.length; i++) {
          context.lineTo(path[i][0], path[i][1]);
        }
        context.stroke();
      }
    });

    await extraCoordinateConfig.coordinates.forEach((path) => {
      context.beginPath();
      context.strokeStyle = extraCoordinateConfig.theme.strokeStyle;
      context.lineWidth = extraCoordinateConfig.theme.lineWidth;
      context.lineCap = "round";

      // context.beginPath();
      if (path && Array.isArray(path)) {
        // context.
        context.moveTo(path[0][0], path[0][1]);
        for (let i = 0; i < path.length; i++) {
          context.lineTo(path[i][0], path[i][1]);
        }
        context.stroke();
      }
    });

    if (strikes.length <= 0) return;
    context.putImageData(strikes[strikes.length - 1], 0, 0);
    strikes.pop();

    // sending event to end user
    if (removeLastCoordinate) {
      // socket.emit(EVENTS.EMIT_UNDO, {
      //     sender: storedLocalDrawPaths.sender,
      //     receiver: extraCoordinateConfig.coordinates,
      //     userInfo: { from_user: fromUser._id, to_user: toUser._id },
      // });
      sendEmitUndoEvent();
    }
  };

  const getReportData = async () => {
    var res = await getReport({
      sessions: id,
      trainer: fromUser?._id,
      trainee: toUser?._id,
    });
    // console.log(res, "set screenshot data for session");
    setScreenShots(res?.data?.reportData);
    setReportObj({ title: res?.data?.title, topic: res?.data?.description });
  };

  const showReportData = async () => {
    // getReportData()
    setIsOpenReport(true);
  };

  function captureVideo(canvasEle, videoEle) {
    let canvas = document.getElementById(canvasEle); // declare a canvas element in your html
    let ctx = canvas.getContext("2d");
    let w, h;
    const v = document.getElementById(videoEle);
    try {
      w = v.videoWidth;
      h = v.videoHeight;
      canvas.width = w;
      canvas.height = h;
      ctx.fillRect(0, 0, w, h);
      ctx.drawImage(v, 0, 0, w, h);
      const a = canvas.toDataURL();
      v.style.backgroundImage = `url(${a})`;
      v.style.backgroundSize = "cover";
      ctx.clearRect(0, 0, w, h); // clean the canvas
      return true;
    } catch (e) {
      // console.log(e);
    }
  }

  const takeScreenshot = () => {
    setIsTooltipShow(false);
    setIsScreenShotModelOpen(false);
    // if (selectedClips?.length) {
    //   if (selectedClips.length === 1) captureVideo("video-canvas-1", "selected-video-1");
    //   else if (selectedClips.length === 2) {
    //     captureVideo("video-canvas-1", "selected-video-1");
    //     captureVideo("video-canvas-2", "selected-video-2");
    //   }
    // }

    const targetElement = document.body;

    const creationBarItem = document.querySelector(".creationBarItem");
    const callActionButtons = document.querySelector(".call-action-buttons");
    const mainNav = document.querySelector(".main-nav");
    const Pause = document.querySelector(".Pause");
    const Pause2 = document.querySelector(".Pause2");
    const progress1 = document.querySelector(".progress1");
    const progress2 = document.querySelector(".progress2");

    const userVideo1 = document.getElementById("user-video-1");
    const userVideo2 = document.getElementById("user-video-2");
    const ChevronLeft = document.getElementById("ChevronLeft");
    const ChevronRight = document.getElementById("ChevronRight");
    const Timer = document.getElementById("sessionEndTime");
    const ssTooltip = document.querySelector(".custom-tooltip-hh");
    // console.log(ssTooltip, 'ssTooltip')
    if (ssTooltip) {
      ssTooltip.style.transition = "opacity 1s";
      ssTooltip.style.visibility = 'hidden';
      ssTooltip.style.display = 'none';
      ssTooltip.style.opacity = "0";
      ssTooltip.style.zIndex = '-1';
    }

    //NOTE - Hide elements with a smooth transition
    if (Timer) {
      Timer.style.transition = "opacity 1s";
      Timer.style.opacity = "0";
    }
    if (ChevronLeft) {
      ChevronLeft.style.transition = "opacity 1s";
      ChevronLeft.style.opacity = "0";
      ChevronLeft.style.background = "#fff";
    }
    if (ChevronRight) {
      ChevronRight.style.transition = "opacity 1s";
      ChevronRight.style.opacity = "0";
      ChevronRight.style.background = "#fff";
    }

    if (Pause) {
      Pause.style.transition = "opacity 1s";
      Pause.style.opacity = "0";
    }
    if (progress1) {
      progress1.style.transition = "opacity 1s";
      progress1.style.opacity = "0";
    }
    if (Pause2) {
      Pause2.style.transition = "opacity 1s";
      Pause2.style.opacity = "0";
    }
    if (progress2) {
      progress2.style.transition = "opacity 1s";
      progress2.style.opacity = "0";
    }
    if (userVideo1 && selectedClips?.length) {
      userVideo1.style.transition = "opacity 1s";
      userVideo1.style.opacity = "0";
    }
    if (userVideo2 && selectedClips?.length) {
      userVideo2.style.transition = "opacity 1s";
      userVideo2.style.opacity = "0";
    }
    if (creationBarItem) {
      creationBarItem.style.transition = "opacity 1s"; // Adjust the duration based on your needs
      creationBarItem.style.opacity = "0";
    }

    if (callActionButtons) {
      callActionButtons.style.transition = "opacity 1s"; // Adjust the duration based on your needs
      callActionButtons.style.opacity = "0";
    }
    if (mainNav) {
      mainNav.style.transition = "opacity 1s"; // Set duration to 0s
      mainNav.style.opacity = "0";
    }

    // if(Pause){
    //   Pause.style.transition = 'opacity 1s'
    //   Pause.style.opacity = '0';
    // }
    // if(progress1){
    //   progress1.style.transition = 'opacity 1s'
    //   progress1.style.opacity = '0';
    // }
    // if(Pause2){
    //   Pause2.style.transition = 'opacity 1s'
    //   Pause2.style.opacity = '0';
    // }
    // if(progress2){
    //   progress2.style.transition = 'opacity 1s'
    //   progress2.style.opacity = '0';
    // }


  
    html2canvas(targetElement, { type: "png" }).then(async (canvas) => {
      // document.body.appendChild(canvas);
      // console.log("1366=======S3",{canvas})
      const dataUrl = canvas.toDataURL("image/png");
      // console.log("1367=======S3",{dataUrl})
      // screenShots.push({
      //   title: "",
      //   description: "",
      //   imageUrl: dataUrl
      // })
      // setScreenShots([...screenShots])
      setIsTooltipShow(true);
      if (ssTooltip) {
        ssTooltip.style.transition = "opacity 1s";
        ssTooltip.style.visibility = 'visible';
        ssTooltip.style.display = 'inline';
        ssTooltip.style.opacity = "1";
        ssTooltip.style.zIndex = '999';
      }
      if (creationBarItem) {
        creationBarItem.style.transition = "opacity 1s";
        creationBarItem.style.opacity = "1";
      }

      if (callActionButtons) {
        callActionButtons.style.transition = "opacity 1s";
        callActionButtons.style.opacity = "1";
      }
      if (mainNav) {
        mainNav.style.transition = "opacity 1s"; // Adjust the duration based on your needs
        mainNav.style.opacity = "1";
      }
      if (Pause) {
        Pause.style.transition = "opacity 1s";
        Pause.style.opacity = "1";
      }
      if (progress1) {
        progress1.style.transition = "opacity 1s";
        progress1.style.opacity = "1";
      }
      if (Pause2) {
        Pause2.style.transition = "opacity 1s";
        Pause2.style.opacity = "1";
      }
      if (progress2) {
        progress2.style.transition = "opacity 1s";
        progress2.style.opacity = "1";
      }
      if (userVideo1 && selectedClips?.length) {
        userVideo1.style.transition = "opacity 1s";
        userVideo1.style.opacity = "1";
      }
      if (userVideo2 && selectedClips?.length) {
        userVideo2.style.transition = "opacity 1s";
        userVideo2.style.opacity = "1";
      }

      if (ChevronLeft) {
        ChevronLeft.style.transition = "opacity 1s";
        ChevronLeft.style.opacity = "1";
        ChevronLeft.style.background = "#000080";
      }
      if (ChevronRight) {
        ChevronRight.style.transition = "opacity 1s";
        ChevronRight.style.opacity = "1";
        ChevronRight.style.background = "#000080";
      }
      if (Timer) {
        Timer.style.transition = "opacity 1s";
        Timer.style.opacity = "1";
      }



      var res = await screenShotTake({
        sessions: id,
        trainer: fromUser?._id,
        trainee: toUser?._id,
      });

      const response = await fetch(dataUrl);
      const blob = await response.blob();

      // Handling Error if SS is not generate image

      if (!blob) {
        return errorHandling("Unable to take Screen Shot");
      }

      if (res?.data?.url) {
        // var result = await getReport({
        //   sessions: id,
        //   trainer: fromUser?._id,
        //   trainee: toUser?._id,
        // });
        // setScreenShots(result?.data?.reportData);
        setIsScreenShotModelOpen(true);
        pushProfilePhotoToS3(res?.data?.url, blob, afterSucessUploadImageOnS3);
      }

      setTimeout(() => {
        // Success message after the screenshot is successfully taken and processed
        toast.success("The screenshot taken successfully.", {
          type: "success",
        });
      }, 2000);

      // const link = document.createElement('a');
      // link.href = dataUrl;
      // link.download = 'screenshot.png';
      // document.body.appendChild(link);
      // link.click();
      // document.body.removeChild(link);
    });
  };




  async function afterSucessUploadImageOnS3() {
    var result = await getReport({
      sessions: id,
      trainer: fromUser?._id,
      trainee: toUser?._id,
    });
    setScreenShots(result?.data?.reportData);
  }

  async function pushProfilePhotoToS3(presignedUrl, uploadPhoto, cb) {
    const myHeaders = new Headers({ "Content-Type": "image/*" });
    await axios.put(presignedUrl, uploadPhoto, {
      headers: myHeaders,
    });

    if (cb) cb();

    const v = document.getElementById("selected-video-1");
    if (v) v.style.backgroundImage = "";
    const v2 = document.getElementById("selected-video-2");
    if (v2) v2.style.backgroundImage = "";
    return true;
  }

  const mediaQuery = window.matchMedia(
    "(min-width: 768px) and (min-width: 1024px)"
  );


  //SECTION - selected Clips and swapping the videos
  //NOTE -  listening both selected clips and swapped videos with single event by type
  socket.on(EVENTS.ON_VIDEO_SELECT, ({ type, videos, mainScreen }) => {
    if (type === "clips") {
      // console.log(videos, "videos");
      setSelectedClips(videos);
      if (videos?.length) {
        resetInitialPinnedUser()
      } else {
        setInitialPinnedUser()
      }
    } else {
      setPinnedUser(mainScreen);
      if (mainScreen) {
        setIsPinned(true);
      } else {
        setIsPinned(false);
      }
    }
  });

  //NOTE - separate funtion for emit seelcted clip videos  and using same even for swapping the videos
  const emitVideoSelectEvent = (type, videos, mainScreen) => {
    socket.emit(EVENTS.ON_VIDEO_SELECT, {
      userInfo: { from_user: fromUser._id, to_user: toUser._id },
      type,
      videos,
      mainScreen,
    });
  };

  //NOTE - emit event after selecting the clips
  useEffect(() => {
    emitVideoSelectEvent("clips", selectedClips, pinnedUser);
  }, [selectedClips?.length]);


  socket.on(EVENTS.ON_VIDEO_PLAY_PAUSE, ({ isPlayingAll, number, isPlaying1, isPlaying2 }) => {
    const playPauseVideo = (videoRef, isPlaying) => {
      if (videoRef?.current) {
        isPlaying ? videoRef.current.play() : videoRef.current.pause();
      }
    };
  
    if (number === "all") {
      playPauseVideo(selectedVideoRef1, isPlayingAll);
      playPauseVideo(selectedVideoRef2, isPlayingAll);
    } else if (number === "one") {
      playPauseVideo(selectedVideoRef1, isPlaying1);
    } else if (number === "two") {
      playPauseVideo(selectedVideoRef2, isPlaying2);
    }
  
    setIsPlaying({ isPlayingAll, number, isPlaying1, isPlaying2 });
  });
  


  //NOTE -  Video Time Update listen
  socket.on(EVENTS.ON_VIDEO_TIME, ({ clickedTime, number }) => {
    if (selectedVideoRef1?.current) {
      if (number === "one") selectedVideoRef1.current.currentTime = clickedTime;
      else selectedVideoRef2.current.currentTime = clickedTime;
    }
  });

  //NOTE -  Video Time Update emit
const emitVideoTimeEvent = (clickedTime, number) => {

    if (isPlaying.isPlaying1) {
    setIsPlaying(prev => ({ ...prev, isPlaying1: false }));
  }
    if (isPlaying.isPlaying1) {
    setIsPlaying(prev => ({ ...prev, isPlaying2: false }));
  }
  if (isPlaying.isPlayingAll) {
    setIsPlaying(prev => ({ ...prev, isPlayingAll: false }));
  }

  socket?.emit(EVENTS.ON_VIDEO_TIME, {
    userInfo: { from_user: fromUser?._id, to_user: toUser?._id },
    clickedTime,
    number,
  });
};

  socket.on(EVENTS.ON_VIDEO_SHOW, ({ isClicked }) => {
    setMaxMin(isClicked);
  });

  const globalProgressBarToggler = (e) => {
    setVideoController(!videoController);

  };

  const handleGlobalProgressBarChange = (e) => {
    const { value } = e.target;
    const maxTime = Math.max(
      selectedVideoRef1.current?.duration || 0,
      selectedVideoRef2.current?.duration || 0
    );

    if (selectedVideoRef1.current) {
      selectedVideoRef1.current.currentTime = value;
      emitVideoTimeEvent(value, "one");
    }

    if (selectedVideoRef2.current) {
      selectedVideoRef2.current.currentTime = value;
      emitVideoTimeEvent(value, "two");
    }

    if (!value) {
      setIsPlaying({ ...isPlaying, isPlayingAll: false });
    }
  };

  const togglePlay = (num) => {

    if (num === 'one' && showThumbnailForFirstVideo) {
      setShowThumbnailForFirstVideo(false)
    }

    if (num === 'two' && showThumbnailForTwoVideo) {
      setShowThumbnailForTwoVideo(false)
    }

    if (num === 'all') {
      if (showThumbnailForFirstVideo) {
        setShowThumbnailForFirstVideo(false)
      }

      if (showThumbnailForTwoVideo) {
        setShowThumbnailForTwoVideo(false)
      }
    }
    console.log(selectedVideoRef1.current)
    var temp = isPlaying;
    temp.number = num;
    console.log(selectedVideoRef1 , 'hello')
    if (
      selectedVideoRef1.current && 
      selectedVideoRef1?.current?.currentTime ===
      selectedVideoRef1?.current?.duration &&
      selectedVideoRef2?.current?.currentTime ===
      selectedVideoRef2?.current?.duration
    ) {
      selectedVideoRef1.current.currentTime = 0;
      emitVideoTimeEvent(0, "one");
      if(selectedVideoRef2.current){
        selectedVideoRef2.current.currentTime = 0;
      }
      emitVideoTimeEvent(0, "two");
    }

    if (num === "all") {
      if (isPlaying.isPlayingAll) {
        selectedVideoRef1?.current?.pause();
        selectedVideoRef2?.current?.pause();
      } else {
        selectedVideoRef1?.current?.play();
        selectedVideoRef2?.current?.play();
      }
      temp = {
        ...isPlaying,
        isPlayingAll: !isPlaying.isPlayingAll,
        isPlaying1: !isPlaying.isPlayingAll,
        isPlaying2: !isPlaying.isPlayingAll,
      };
    } else if (num === "one") {
      if (isPlaying.isPlaying1) selectedVideoRef1?.current?.pause();
      else selectedVideoRef1?.current?.play();
      temp = { ...isPlaying, isPlaying1: !isPlaying.isPlaying1 };
    } else if (num === "two") {
      if (isPlaying?.isPlaying2) selectedVideoRef2?.current?.pause();
      else selectedVideoRef2.current.play();
      temp = { ...isPlaying, isPlaying2: !isPlaying.isPlaying2 };
    }

    socket?.emit(EVENTS?.ON_VIDEO_PLAY_PAUSE, {
      userInfo: { from_user: fromUser?._id, to_user: toUser?._id },
      ...temp,
    });
    setIsPlaying({ ...temp });
  };


  // console.log("video time--------->",videoTime)
  const handleTimeUpdate = (videoRef, progressBarRef, number) => {
    let num = number;
    if (!videoRef.current) return; // Ensure videoRef is valid
  
    // Update progress bar value
    if (progressBarRef?.current) {
      progressBarRef.current.value = videoRef.current.currentTime || 0;
    }
  
    // Check if video has ended
    if (videoRef.current.duration === videoRef.current.currentTime) {
      togglePlay(number === 1 ? "one" : "two");
      videoRef.current.currentTime = 0;
      emitVideoTimeEvent(0, number);
    }
  
    // Calculate remaining time
    const remainingTime = videoRef.current.duration - videoRef.current.currentTime;
  
    // Update video time state
    setVideoTime((prevVideoTime) => ({
      ...prevVideoTime,
      [`currentTime${number}`]: formatTime(videoRef.current.currentTime),
      [`remainingTime${number}`]: formatTime(remainingTime),
    }));
  };
  
  // Helper function to format time as MM:SS
  const formatTime = (timeInSeconds) => {
    const minutes = Math.floor(timeInSeconds / 60);
    const seconds = Math.floor(timeInSeconds % 60);
    return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  };
  

  // Usage for first video
  const handleTimeUpdate1 = () => handleTimeUpdate(selectedVideoRef1, progressBarRef, 1);

  // Usage for second video
  const handleTimeUpdate2 = () => handleTimeUpdate(selectedVideoRef2, progressBarRef2, 2);

  const handleProgressBarClick = (e, number) => {
    var clickedTime;
    if (number === "one") {
      clickedTime =
        (e?.nativeEvent?.offsetX / progressBarRef?.current?.offsetWidth) *
        progressBarRef?.current.getAttribute("max");
      selectedVideoRef1.current.currentTime = clickedTime;
    } else {
      clickedTime =
        (e?.nativeEvent?.offsetX / progressBarRef2?.current?.offsetWidth) *
        progressBarRef2?.current.getAttribute("max");
      selectedVideoRef2.current.currentTime = clickedTime;
    }
    emitVideoTimeEvent(clickedTime, number)
  };

  const handleProgressBarChange = (e, number) => {
    const clickedTime = e.target.value;
    console.log(clickedTime, "handleProgressBarChange");
    if (number === "one") {
      selectedVideoRef1.current.currentTime = clickedTime;
    } else {
      selectedVideoRef2.current.currentTime = clickedTime;
    }

    socket?.emit(EVENTS?.ON_VIDEO_TIME, {
      userInfo: { from_user: fromUser?._id, to_user: toUser?._id },
      clickedTime: clickedTime,
      number: number,
    });
  };
  const handleVolumeChange = () => {
    // Update the video volume based on the input value (0 to 1)
    const newVolume = parseFloat(volumeInputRef.current.value);
    selectedVideoRef1.current.volume = newVolume;
    setVolume(newVolume); // Update state
  };

  const handleVolumeChange2 = () => {
    // Update the video volume based on the input value (0 to 1)
    const newVolume = parseFloat(volumeInputRef2.current.value);
    selectedVideoRef2.current.volume = newVolume;
    setVolume2(newVolume); // Update state
  };

  useEffect(() => {
    setScreenShot();
  }, [screenShots?.length]);

  // useEffect(() => {
  //   const canvas = canvasRef.current;
  //   if (canvas) {
  //     const bookingsElement = document.getElementById('bookings');
  //     if (bookingsElement) {
  //       canvas.width = bookingsElement.clientWidth;
  //       canvas.height = bookingsElement.clientHeight;
  //     }
  //   }
  // }, []);

  const setScreenShot = async () => {
    var newReportImages = [];

    for (let index = 0; index < screenShots?.length; index++) {
      const element = screenShots[index];
      try {
        const response = await fetch(`${awsS3Url}${element?.imageUrl}`);
        const blob = await response.blob();
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64data = reader.result.split(",")[1];
          newReportImages[index] = {
            ...element,
            imageUrl: `data:image/jpeg;base64,${base64data}`,
          };
        };
        reader.readAsDataURL(blob);
      } catch (error) {
        // console.error("Error fetching or converting image:", error);
      }
    }

    setReportArr([...newReportImages]);
  };

  var pdf = new jsPDF();

  const generatePDF = async () => {
    const content = document.getElementById("report-pdf");
    content.style.removeProperty("display");

    html2canvas(content, { type: "png" }).then(async (canvas) => {
      const imgData = canvas.toDataURL("image/png");

      // Calculate the width of the page
      var pageWidth = pdf.internal.pageSize.width;

      // Calculate the aspect ratio of the canvas
      var aspectRatio = canvas.width / canvas.height;

      // Calculate the height to maintain the aspect ratio
      var imgHeight = pageWidth / aspectRatio;

      // Add the canvas as an image to the PDF
      pdf.addImage(imgData, "PNG", 0, 0, pageWidth, imgHeight);
      // pdf.save('yourDocument.pdf');

      // Get the data URL of the PDF
      const generatedPdfDataUrl = pdf.output("dataurlstring");

      // Convert data URL to Blob
      const byteCharacters = atob(generatedPdfDataUrl.split(",")[1]);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const pdfBlob = new Blob([new Uint8Array(byteNumbers)], {
        type: "application/pdf",
      });

      // Create a File from the Blob
      const pdfFile = new File([pdfBlob], "generated_pdf.pdf", {
        type: "application/pdf",
      });

      var link = await createUploadLink();
      if (link) pushProfilePDFToS3(link, pdfFile);

      content.style.display = "none";

      var res = await createReport({
        sessions: id,
        trainer: fromUser?._id,
        trainee: toUser?._id,
        title: reportObj?.title,
        topic: reportObj?.topic,
        reportData: screenShots,
      });
      setIsOpenReport(false);
    });
  };

  async function pushProfilePDFToS3(presignedUrl, uploadPdf) {
    const myHeaders = new Headers({ "Content-Type": "application/pdf" });
    axios
      .put(presignedUrl, uploadPdf, {
        headers: myHeaders,
        onUploadProgress: (progressEvent) => {
          const { loaded, total } = progressEvent;
          const percentCompleted = (loaded / total) * 100;
          // console.log("percentCompletedpercentCompleted", percentCompleted);
        },
      })
      .then((response) => {
        // console.log(response);
      })
      .catch((error) => {
        // console.error("Error:", error);
      });
  }

  const createUploadLink = async () => {
    var payload = { session_id: id };
    const data = await getS3SignPdfUrl(payload);
    if (data?.url) return data?.url;
    else return "";
  };

  const handleRemoveImage = async (filename) => {
    var res = await removeImage({
      sessions: id,
      trainer: fromUser?._id,
      trainee: toUser?._id,
      filename: filename,
    });
    getReportData();
  };

  const handleCropImage = async (filename, blob) => {
    var res = await cropImage({
      sessions: id,
      trainer: fromUser?._id,
      trainee: toUser?._id,
      oldFile: filename,
    });
    if (res?.data?.url) await pushProfilePhotoToS3(res?.data?.url, blob);
    getReportData();
    setIsOpenCrop(false);
  };


  const renderCallActionButtons = () => {
    // console.log("code:0.0.2" + session_end_time);
    return (
      <div className="call-action-buttons z-50 my-3 " >
        <Tooltip
          title={isMuted ? "Unmute" : "Mute"}
          position="bottom"
          trigger="mouseenter"
        >
          <div
            className={`icon-btn ${isMuted ? "btn-danger" : "btn-light"} ${mediaQuery.matches ? "btn-xl" : "btn-sm"
              } button-effect mic`}
            style={{ height: '4vw', width: '4vw' }}
            onClick={() => {
              // if (remoteVideoRef && remoteVideoRef.current) {
              //   socket.emit(EVENTS.VIDEO_CALL.MUTE_ME, {
              //     userInfo: { from_user: fromUser._id, to_user: toUser._id },
              //     isClicked: !isMuted,
              //   });
              //   setIsMuted(!isMuted);
              // }

              if (localStream) {
                const audioTracks = localStream.getAudioTracks();
                if (audioTracks.length > 0) {
                  audioTracks[0].enabled = !audioTracks[0].enabled;
                  setIsMuted(!audioTracks[0].enabled);
                }
              }
              if (micStream) {
                const audioTracks = micStream.getAudioTracks();
                if (audioTracks.length > 0) {
                  audioTracks[0].enabled = !audioTracks[0].enabled;
                  setIsMuted(!audioTracks[0].enabled);
                }
              }
            }}
          >
            <MicOff />
          </div>
        </Tooltip>
        <Tooltip
          title={isFeedStopped ? "Video Play" : "Video Pause"}
          position="bottom"
          trigger="mouseenter"
        >
          <div
            className={`icon-btn btn-light  button-effect ${mediaQuery.matches ? "btn-xl" : "btn-sm"
              } ml-3`}
            style={{ height: '4vw', width: '4vw' }}
            onClick={() => {
              // console.log("outside of local stream  statement");
              if (localStream) {
                // console.log("inside of local stream  statement");
                localStream.getVideoTracks().forEach((track) => {
                  track.enabled = !track.enabled; // Toggle camera state
                });
                socket.emit(EVENTS.VIDEO_CALL.STOP_FEED, {
                  userInfo: { from_user: fromUser._id, to_user: toUser._id },
                  feedStatus: !isFeedStopped,
                });
                setIsFeedStopped(!isFeedStopped);
              }

              // if (videoRef.current && videoRef.current.srcObject) {
              //   const availableTracks = videoRef.current.srcObject.getTracks();
              //   const availableVideoTracks =
              //     videoRef.current.srcObject.getVideoTracks();
              //   for (
              //     let videoRefIndex = 0;
              //     videoRefIndex < availableTracks.length;
              //     videoRefIndex++
              //   ) {
              //     const track = availableTracks[videoRefIndex];
              //     track.enabled = isFeedStopped;
              //   }

              //   for (
              //     let videoRefIndex = 0;
              //     videoRefIndex < availableVideoTracks.length;
              //     videoRefIndex++
              //   ) {
              //     const track = availableVideoTracks[videoRefIndex];
              //     track.enabled = isFeedStopped;
              //   }
              // }
              // if (remoteVideoRef && remoteVideoRef.current) {
              //   socket.emit(EVENTS.VIDEO_CALL.STOP_FEED, {
              //     userInfo: { from_user: fromUser._id, to_user: toUser._id },
              //     feedStatus: isFeedStopped,
              //   });
              // }
            }}
          >
            {!isFeedStopped ? <PauseCircle /> : <PlayCircle />}
          </div>
        </Tooltip>

        <Tooltip title={"End Call"} position="bottom" trigger="mouseenter">
          <div
            className={`icon-btn btn-danger button-effect ${mediaQuery.matches ? "btn-xl" : "btn-sm"
              }  ml-3`}
            style={{ height: '4vw', width: '4vw' }}
            onClick={() => {
              setCallEnd(true);
              cutCall();
            }}
          >
            <Phone />
          </div>
        </Tooltip>

        {!displayMsg?.showMsg && accountType === AccountType.TRAINER && (
          <Tooltip
            title={
              selectedClips.length
                ? "Exit clip analysis mode"
                : "Clip analysis mode"
            }
            position="bottom"
            trigger="mouseenter"
          >
            <div
              className={
                !maxMin
                  ? `icon-btn btn-light  button-effect  ${mediaQuery.matches ? "btn-xl" : "btn-sm"
                  }  ml-3`
                  : `icon-btn btn-danger  button-effect  ${mediaQuery.matches ? "btn-xl" : "btn-sm"
                  }  ml-3`
              }
              style={{ height: '4vw', width: '4vw' }}
              onClick={() => {
                // socket.emit(EVENTS.ON_VIDEO_SHOW, {
                //   userInfo: { from_user: fromUser._id, to_user: toUser._id },
                //   isClicked: !maxMin,
                // });
                // setMaxMin(!maxMin)
                if (selectedClips?.length) {
                  setIsOpenConfirm(true);
                } else {
                  setIsOpen(true);
                }
              }}
            >
              <ExternalLink />
            </div>
          </Tooltip>
        )}

        {selectedClips?.length && accountType === AccountType.TRAINER ? (
          <Tooltip
            title={videoController ? "Lock" : "Unlock"}
            position="bottom"
            trigger="mouseenter"
          >
            <div
              className={`icon-btn btn-light  button-effect ${mediaQuery.matches ? "btn-xl" : "btn-sm"
                } ml-3`}
              style={{ height: '4vw', width: '4vw' }}
              onClick={globalProgressBarToggler}
            >
              {/* {isPlaying?.isPlayingAll ? <PauseCircle /> : <PlayCircle />} */}
              {videoController ? <FaLock /> : <FaUnlock />}
            </div>
          </Tooltip>
        ) : (
          <></>
        )}

        {accountType === AccountType.TRAINER ? (
          <Tooltip
            title={"Screenshot"}
            position="bottom"
            trigger="mouseenter"
            className="custom-tooltip-hh"
            disabled={width1000}
          >
            <div
              className={`icon-btn btn-light button-effect ${mediaQuery.matches ? "btn-xl" : "btn-sm"
                } ml-3`}
              style={{ height: '4vw', width: '4vw' }}
              onClick={() => {
                setIsTooltipShow(false)
                setTimeout(() => {
                  takeScreenshot();
                }, 30);
              }}
            >
              <Aperture />
            </div>
          </Tooltip>
        ) : (
          <></>
        )}

        {accountType === AccountType.TRAINER ? (
          <Tooltip title={"Game Plans"} position="bottom" trigger="mouseenter">
            <div
              className={`icon-btn btn-light  button-effect ${mediaQuery.matches ? "btn-xl" : "btn-sm"
                } ml-3`}
              style={{ height: '4vw', width: '4vw' }}
              onClick={showReportData}
            >
              <FilePlus />
            </div>
          </Tooltip>
        ) : (
          <></>
        )}

        {/* {accountType === AccountType.TRAINEE ? (
          <div
            className={`icon-btn btn-light  button-effect ${mediaQuery.matches ? "btn-xl" : "btn-sm"
              } ml-3`}
            onClick={recording ? stopRecording : startRecording}
          >
            {recording ? <VideoOff /> : <Video />}
          </div>
        ) : (
          <></>
        )} */}

        <Modal
          isOpen={isOpenConfirm}
          toggle={() => {
            setIsOpenConfirm(false);
          }}
        >
          <ModalHeader
            toggle={() => {
              setIsOpenConfirm(false);
            }}
            close={() => <></>}
          >
            Confirm
          </ModalHeader>
          <ModalBody>
            Are you sure you want to exit clip analysis mode?
          </ModalBody>
          <ModalFooter>
            <Button
              color="primary"
              onClick={() => {
                setInitialPinnedUser();
                setSelectedClips([]);
                setIsOpenConfirm(false);
              }}
            >
              Confirm
            </Button>{" "}
            <Button
              color="secondary"
              onClick={() => {
                setIsOpenConfirm(false);
              }}
            >
              Cancel
            </Button>
          </ModalFooter>
        </Modal>
      </div>
    );
  };

  const isOnlyOneVideo = {
    height: isPinned ? "150px" : "73vh",
    // width: "100%",
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    marginRight: isPinned ? "0px !important" : "-15px",
    marginLeft: isPinned ? "0px !important" : "-15px",
    paddingTop:"15px"
  };
  const isTwoVideos = {
    height: isPinned ? "150px" : "73vh",
    width: "100%",
    marginRight: isPinned ? "0px !important" : "-15px",
    marginLeft: isPinned ? "0px !important" : "-15px",
    margin:'auto',
    paddingTop:"15px"
  };


  const handlePlayClick = () => {
    if (videoRef.current) {
      videoRef.current.play().catch(error => {
        // console.error('Playback failed:', error);
        // Implement a user-friendly message or fallback here
      });
    }
  };


  function canPlayVideo(videoUrl) {
    // Create a video element to test compatibility
    const video = document.createElement('video');

    // Check if the browser supports the video element
    if (typeof video.canPlayType === 'function') {
      // Extract the file extension from the URL
      const fileExtension = videoUrl.split('.').pop().toLowerCase();

      // Define MIME types based on common video extensions
      const mimeTypes = {
        'mp4': 'video/mp4',
        'webm': 'video/webm',
        'ogg': 'video/ogg',
        'quicktime': 'video/quicktime'
      };

      // Get the MIME type based on the file extension
      const mimeType = mimeTypes[fileExtension] || '';

      // Check if the browser can play this video type
      if (video.canPlayType(mimeType)) {
        // console.log(`This browser can play ${fileExtension} videos`);
        return true;
      } else {
        // console.warn(`This browser cannot play ${fileExtension} videos`);
        return false;
      }
    } else {
      // console.warn('Video playback is not supported in this browser');
      return false;
    }
  }

  // Usage
  // const videoUrl = "https://example.com/video.mp4";
  // if (canPlayVideo(videoUrl)) {
  //   // Load and play the video
  // } else {
  //   // Show alternative content or message
  // }

  // if (canPlayVideo(videoUrl)) {
  //   // Load and play the video
  // } else {
  //   // Show alternative content or message
  // }
  // console.log('..pinnedUser...',pinnedUser)

  useEffect(() =>{

        console.log("hello" , document.getElementById("clips-container-id")?.clientX)
  },[])
  if (isIOS || isMobile) {
    return (
      <React.Fragment>
        <Script
          src="https://vjs.zencdn.net/7.20.3/video.min.js"
          strategy="lazyOnload"
        />
        <OrientationModal isOpen={modal} />
        {/* <canvas
          ref={canvasRef}
          id="drawing-canvas"
          width={document.getElementById("third")?.clientWidth}
          height={document.getElementById("third")?.clientHeight}
          className="canvas-print absolute all-0"
          style={{ left: document.getElementById("third")?.clientX, top: document.getElementById("third")?.clientY, }}
        /> */}
        <div
          className="row"
          style={{ height: "100%", display: "flex", alignItems: "center", marginTop: "env(safe-area-inset-bottom)"}}
        >
          {/* 1 */}
          {accountType === AccountType.TRAINER ? (
            <div id="sidetoolbar" className="col-lg-1 col-md-1 col-sm-2 z-50" style={{ flex: '0 0 9px', width: '9px', }}>
              <div>
                <CanvasMenuBar
                  isOpen={isOpen}
                  setIsOpen={setIsOpen}
                  setSketchPickerColor={(rgb) => {
                    setSketchPickerColor(rgb);
                  }}
                  undoDrawing={() => {
                    undoDrawing(
                      {
                        coordinates: storedLocalDrawPaths.sender,
                        theme: canvasConfigs.sender,
                      },
                      {
                        coordinates: storedLocalDrawPaths.receiver,
                        theme: {
                          lineWidth: canvasConfigs.receiver.lineWidth,
                          strokeStyle: canvasConfigs.receiver.strokeStyle,
                        },
                      }
                    );
                  }}
                  sketchPickerColor={sketchPickerColor}
                  canvasConfigs={canvasConfigs}
                  setCanvasConfigs={(config) => {
                    canvasConfigs = config;
                  }}
                  drawShapes={(shapeType) => {
                    selectedShape = shapeType;
                  }}
                  refreshDrawing={() => {
                    // deleting the canvas drawing
                    storedLocalDrawPaths.sender = [];
                    storedLocalDrawPaths.receiver = [];
                    clearCanvas();
                    sendClearCanvasEvent();
                  }}
                  selectedClips={selectedClips}
                  setSelectedClips={setSelectedClips}
                  toUser={toUser}
                  isCanvasMenuNoteShow={isCanvasMenuNoteShow}
                  setIsCanvasMenuNoteShow={setIsCanvasMenuNoteShow}
                  setMicNote={setMicNote}
                  setClipSelectNote={setClipSelectNote}
                  clipSelectNote={clipSelectNote}
                  setCountClipNoteOpen={setCountClipNoteOpen}
                  resetInitialPinnedUser={resetInitialPinnedUser}
                />
              </div>
            </div>
          ) : (
            <div className="" style={{ width: '10px' }}></div>
          )}

          {/* 2 */}

          {
            <div
              className={isIOS == true ? "col-lg-8 col-md-9 col-sm-8 important-margin" : "col-lg-8 col-md-8 col-sm-8 important-margin"}
              id="third"
              style={{
                height: "100%",
                display: "flex",
                alignItems: "center",
                justifyContent: "space-evenly",
                flexDirection: "column",
                alignSelf: 'baseline',
                // top: height < 500 ? "-63px" : ""
              }}
            >
              {displayMsg?.msg ? (
                <div
                  className="no-user-joined font-weight-bold text-center"
                  style={{
                    margin: displayMsg?.msg ? (width1000 ? "0px" : "10px") : "",
                    zIndex: displayMsg?.msg ? 8 : 1,
                    fontSize: width1000 ? "14px" : "20px",
                  }}
                >
                  {displayMsg?.msg}
                </div>
              ) : null}
              <canvas
                ref={canvasRef}
                id="drawing-canvas"
                width={document.getElementById("third")?.clientWidth}
                height={document.getElementById("drawing-canvas")?.clientHeight}
                className="canvas-print absolute all-0"
                style={{ height: (isIOS ? (isPinned ? "52vh" : "48vh") : (isPinned ? "73vh" : "66vh")), width: '100%' }}
              />
              {selectedClips?.length ? (
                <div
                  className={
                    isPinned
                      ? accountType === AccountType.TRAINER
                        ? pinnedUser === "user-video-1"
                          ? height < 500 ? "switch-clips-container-for-mobile_1" : "switch-clips-container_1"
                          : height < 500 ? "scs2-mobile_1" : "scs2_1"
                        : accountType === AccountType.TRAINEE &&
                          pinnedUser === "user-video-1"
                          ? height < 500 ? "scs2-mobile_1" : "scs2_1"
                          : height < 500 ? "switch-clips-container-for-mobile_1" : "switch-clips-container_1"
                      : "row"
                  }
                  style={{
                    zIndex: isPinned ? "999" : "auto",
                    backgroundColor: isPinned ? "#353535" : "",
                    borderRadius: isPinned ? "10px" : "",
                    padding: isPinned ? "10px" : "5px",
                    marginTop: accountType === AccountType.TRAINER ? isPinned && selectedClips?.length && pinnedUser === "user-video-1" ? (isIOS ? "100px" : "65px") : !isPinned && selectedClips?.length ? '10px' : '50px' : isPinned && selectedClips?.length && pinnedUser === "user-video-2" ? (isIOS ? "100px" : "65px") : !isPinned && selectedClips?.length ? '10px' : '50px',
                    top: accountType === AccountType.TRAINER ? isPinned && selectedClips?.length && pinnedUser === "user-video-2" ? '0px' : '' :
                      // trainee
                      isPinned && selectedClips?.length && pinnedUser === "user-video-2" ? '' : '0px',
                    // overflow: 'hidden',
                    height:
                      !isPinned && selectedClips?.length ? (isIOS ? "55vh" : "73vh") : '12vw',
                    width: !isPinned && selectedClips?.length ? '90%' : ''

                  }}
                  onClick={() => {
                    if (accountType === AccountType.TRAINER) {
                      emitVideoSelectEvent("swap", selectedClips, null);
                      setPinnedUser(null);
                      setIsPinned(false);
                    }
                  }}
                >
                  <div
                    className="row"
                    style={{
                      ...(mediaQuery.matches
                        ? selectedClips?.length === 1
                          ? isOnlyOneVideo
                          : isTwoVideos
                        : {}),
                      // height: '100%',
                      width: '100%',
                      margin: ' 0',
                      // height: isPinned ? "100%" :  accountType === AccountType.TRAINER ? "30vw" :"34.5vw",
                      height: isPinned ? "100%" : accountType === AccountType.TRAINER ?   (isIOS ? "48vh" : "63vh") :   (isIOS ? "48vh" : "63vh"),
                    }}
                  >
                    {selectedClips.length && selectedClips[0] ? (
                      <div
                        className="col-lg-6 col-md-6 col-sm-6 col-xs-12"
                        style={{
                          // padding: "1px !important",
                          height: "100%",
                          padding: 0,
                          margin:'auto'
                        }}
                      >
                       
                        <LazyVideo
                          id="selected-video-1"
                          style={{
                            marginLeft: accountType === AccountType.TRAINER && !isPinned ? '10%' : '0%',
                            // height: isPinned ? "100%" :  accountType === AccountType.TRAINER ? "28vw" :"34.5vw",
                            height: isPinned ? "95%" : accountType === AccountType.TRAINER ?  (isIOS ? "45vh" : "63vh")  :  (isIOS ? "55vh" : "63vh") ,
                            width: accountType === AccountType.TRAINER && !isPinned ? "90%" : '100%',
                            objectFit: "cover",
                          }}
                          ref={selectedVideoRef1}
                          onTimeUpdate={handleTimeUpdate1}
                          poster={Utils?.generateThumbnailURL(selectedClips[0])}
                          src={Utils?.generateVideoURL(selectedClips[0])}
                        />
                        {/* <canvas id="video-canvas-1" hidden></canvas> */}
                        {accountType === AccountType.TRAINER &&
                          !videoController &&
                          !isPinned && (
                            <>
                              <div
                                className="Pause"
                                style={{
                                  position: "relative",
                                  zIndex: 10,
                                  display: "flex",
                                  // justifyContent: "center",
                                  alignItems: "center",
                                  height: '5vw',
                                }}
                              >
                                <div>
                                  <p style={{ margin: 0, marginRight: "10px", fontSize: 'calc(12px + 1*(100vw - 320px) / 1600)' }}>
                                    {videoTime?.currentTime1}
                                  </p>{" "}
                                </div>
                                <div className="external-control-bar">
                                  <button
                                    className="btn btn-primary px-1 py-1 my-3 mr-2"
                                    onClick={() => togglePlay("one")}
                                    style={{ minWidth: '0px' }}
                                  >
                                    {isPlaying?.isPlaying1 ? (
                                      <Pause
                                        style={{ verticalAlign: "middle", height: '2vw' }}
                                      />
                                    ) : (
                                      <Play style={{ verticalAlign: "middle", height: '2vw' }} />
                                    )}
                                  </button>
                                </div>

                                {/* UI changed of video time slider and made it on onChange effect  */}

                                <input
                                  className="wid-mid"
                                  id="vid_id"
                                  type="range"
                                  ref={progressBarRef}
                                  step="0.01"
                                  value={
                                    selectedVideoRef1.current?.currentTime || 0
                                  }
                                  max={selectedVideoRef1.current?.duration || 100}
                                  onChange={(e) =>
                                    handleProgressBarChange(e, "one")
                                  }
                                />
                                <div>
                                  <p
                                    style={{
                                      margin: 0,
                                      marginLeft: "10px",
                                      fontSize: 'calc(12px + 1*(100vw - 320px) / 1600)'
                                    }}
                                  >
                                    {videoTime?.remainingTime1}
                                  </p>{" "}
                                </div>
                              </div>
                            </>
                          )}
                      </div>
                    ) : null}
                    {selectedClips.length && selectedClips[1] ? (
                      <div
                        className="col-lg-6 col-md-6 col-sm-6 col-xs-12"
                        style={{
                          // padding: "1px",
                          height: "100%",
                          padding: 0,
                          margin:'auto'
                        }}
                      >


                        <LazyVideo
                          id="selected-video-2"
                          style={{
                            // height: isPinned ? "100%" : accountType === AccountType.TRAINER ? "28vw" :"34.5vw",
                            height: isPinned ? "95%" : accountType === AccountType.TRAINER ? (isIOS ? "45vh" : "63vh")  :  (isIOS ? "55vh" : "63vh") ,
                            width: accountType === AccountType.TRAINER && !isPinned ? "90%" : '100%',
                            objectFit: "cover",
                          }}
                          ref={selectedVideoRef2}
                          onTimeUpdate={handleTimeUpdate2}
                          poster={Utils?.generateThumbnailURL(selectedClips[1])}
                          src={Utils?.generateVideoURL(selectedClips[1])}
                        />
                        {/* <canvas id="video-canvas-2" hidden></canvas> */}
                        {accountType === AccountType.TRAINER &&
                          !videoController &&
                          !isPinned && (
                            <>
                              <div
                                className="Pause2"
                                style={{
                                  position: "relative",
                                  zIndex: 10,
                                  display: "flex",
                                  // justifyContent: "center",
                                  alignItems: "center",
                                  height: '5vw',
                                }}
                              >
                                <div>
                                  <p style={{ margin: 0, marginRight: "10px", fontSize: 'calc(12px + 1*(100vw - 320px) / 1600)' }}>
                                    {videoTime?.currentTime2}
                                  </p>{" "}
                                </div>
                                <div className="external-control-bar">
                                  <button
                                    className="btn btn-primary px-1 py-1 my-3 mr-2 "
                                    onClick={() => togglePlay("two")}
                                    style={{ minWidth: '0px' }}
                                  >
                                    {isPlaying?.isPlaying2 ? (
                                      <Pause
                                        style={{ verticalAlign: "middle", height: '2vw' }}
                                      />
                                    ) : (
                                      <Play style={{ verticalAlign: "middle", height: '2vw' }} />
                                    )}
                                  </button>
                                </div>

                                {/* UI changed of video time slider and made it on onChange effect  */}
                                <input
                                  type="range"
                                  id="vid_id"
                                  className="wid-mid"
                                  // className="progress"
                                  ref={progressBarRef2}
                                  step="0.01"
                                  value={
                                    selectedVideoRef2.current?.currentTime || 0
                                  }
                                  max={selectedVideoRef2.current?.duration || 100}
                                  onChange={(e) =>
                                    handleProgressBarChange(e, "two")
                                  }
                                />
                                <div>
                                  <p style={{ margin: 0, marginLeft: "10px" }}>
                                    {videoTime?.remainingTime2}
                                  </p>{" "}
                                </div>
                              </div>
                              {/* commented volume rannge  for now */}

                            </>
                          )}
                      </div>
                    ) : null}
                  </div>
                  {accountType === AccountType.TRAINER &&
                    videoController &&
                    !isPinned && (
                      <>
                        <div
                          className="Pause"
                          style={{
                            position: "relative",
                            zIndex: 10,
                            display: "flex",
                            justifyContent: "center",
                            alignItems: "center",
                            marginInline: "auto",
                            width: '100%',
                            height: '3vw'
                          }}
                        >
                          <div className="external-control-bar">
                            <button
                              className="btn btn-primary px-1 py-1 my-3 mr-2"
                              style={{ minWidth: '0px' }}
                              onClick={() => togglePlay("all")}
                            >
                              {isPlaying?.isPlayingAll ? (
                                <Pause style={{ verticalAlign: "middle" }} />
                              ) : (
                                <Play style={{ verticalAlign: "middle" }} />
                              )}
                            </button>
                          </div>
                          <input
                            type="range"
                            ref={globalProgressBarRef}
                            step="0.01"
                            value={
                              (selectedVideoRef1.current?.currentTime || 0) >
                                (selectedVideoRef2.current?.currentTime || 0)
                                ? selectedVideoRef1.current?.currentTime || 0
                                : selectedVideoRef2.current?.currentTime || 0
                            }
                            max={
                              (selectedVideoRef1.current?.duration || 0) >
                                (selectedVideoRef2.current?.duration || 0)
                                ? selectedVideoRef1.current?.duration || 0
                                : selectedVideoRef2.current?.duration || 0
                            }
                            onChange={handleGlobalProgressBarChange}
                            style={{ width: "450px" }}
                          />
                        </div>
                      </>
                    )}
                </div>
              ) : null}

              {/* Timer  */}
              {isTraineeJoined &&
              <div
                id="sessionEndTime"
                style={{
                  position: "absolute",
                  top: width768 ? (!displayMsg?.msg ? "1%" : "20px") : "3%",
                  right: "-125px",
                  zIndex: 999,
                  width: displayMsg?.msg ? '100%' : ''
                }}
              >
                <div
                  className={displayMsg?.msg ? 'text-center-displayMsg' : "text-center"}
                  style={{
                    display: "flex",
                    fontSize: "12px",
                    justifyContent: "center",
                    alignItems: "center",
                    flexDirection: 'column',
                  }}
                >
                  <h3 style={{ fontSize: 'calc(14px + 2*(100vw - 320px) / 1600)' }}>Time remaining</h3>
                  <h2 style={{ fontSize: 'calc(14px + 2*(100vw - 320px) / 1600)' }}> {timeDifference}</h2>
                </div>
              </div>
}
              {/* User Video 1 */}

              <div
                id="user-video-1"
                className={
                  !selectedClips.length &&
                    isPinned &&
                    ((accountType === AccountType.TRAINER &&
                      pinnedUser === "user-video-2") ||
                      (accountType === AccountType.TRAINEE &&
                        pinnedUser === "user-video-1"))
                    ? // pinnedUser === "user-video-2"
                    "scs2_1"
                    : !selectedClips.length &&
                      isPinned &&
                      // pinnedUser === "user-video-1"
                      ((accountType === AccountType.TRAINER &&
                        pinnedUser === "user-video-1") ||
                        (accountType === AccountType.TRAINEE &&
                          pinnedUser === "user-video-2"))
                      ? "switch-user-video"
                      : selectedClips.length &&
                        isPinned &&
                        selectedClips.length &&
                        ((accountType === AccountType.TRAINER &&
                          pinnedUser === "user-video-1") ||
                          (accountType === AccountType.TRAINEE &&
                            pinnedUser === "user-video-2"))
                        ? "switch-user-video"
                        : selectedClips?.length !== 0 && mediaQuery.matches
                          ? "scs_1"
                          : ""
                }
                style={{
                  zIndex:
                    !selectedClips.length &&
                      isPinned &&
                      // pinnedUser === "user-video-2"
                      ((accountType === AccountType.TRAINER &&
                        pinnedUser === "user-video-2") ||
                        (accountType === AccountType.TRAINEE &&
                          pinnedUser === "user-video-1"))
                      ? "999"
                      : selectedClips?.length &&
                        ((accountType === AccountType.TRAINER &&
                          pinnedUser !== "user-video-1") ||
                          (accountType === AccountType.TRAINEE &&
                            pinnedUser !== "user-video-2")) &&
                        isPinned
                        ? 999
                        : selectedClips?.length && !pinnedUser && !isPinned
                          ? 999
                          : "auto",
                  width: accountType === AccountType.TRAINER ? !selectedClips.length && !isPinned ? '' : isPinned && pinnedUser === "user-video-1" ? '' : '25%' : !selectedClips.length && !isPinned ? '' : isPinned && pinnedUser === "user-video-1" ? '25%' : selectedClips.length && !isPinned ? '25% ' : '',
                  height:
                    accountType === AccountType.TRAINER && selectedClips.length &&
                      isPinned && pinnedUser === "user-video-1" ? (isIOS ? "52vh" : "73vh") :
                      !selectedClips.length &&
                        isPinned &&
                        // pinnedUser === "user-video-2"
                        ((accountType === AccountType.TRAINER &&
                          pinnedUser === "user-video-2") ||
                          (accountType === AccountType.TRAINEE &&
                            pinnedUser === "user-video-1"))
                        ? height < 500 ? "12vw" : "12vw"
                        : selectedClips?.length === 0 ||
                          (accountType === AccountType.TRAINER &&
                            pinnedUser === "user-video-1") ||
                          (accountType === AccountType.TRAINEE &&
                            pinnedUser === "user-video-2")
                          ? width500
                            ? "380px"
                            : height < 500 ?(isIOS ? "52vh" : "73vh") : "500px"
                          : height < 500 ? "12vw" : "12vw",
                  marginTop: accountType === AccountType.TRAINER ?
                    displayMsg?.msg ? "0px" :
                      isPinned && pinnedUser === "user-video-1" ? '10px' :
                        selectedClips?.length && isPinned && pinnedUser === "user-video-2" ? (isIOS ? "100px" : "86px") : (isIOS ? "100px" : "86px")
                    :
                    // trainee
                    displayMsg?.msg && isPinned && pinnedUser === "user-video-2" ? "0px" : displayMsg?.msg && isPinned && pinnedUser === "user-video-1" ? "0px" :
                      isPinned && pinnedUser === "user-video-2" ? '10px' :
                        selectedClips.length && isPinned && pinnedUser === "user-video-1" ? '65px' : isPinned && pinnedUser === "user-video-1" ? (isIOS ? "100px" : "50px") : (isIOS ? "100px" : "50px"),
                  top:
                    accountType === AccountType.TRAINER && displayMsg?.msg && isPinned && pinnedUser === "user-video-2" ? "110px" : accountType === AccountType.TRAINER && displayMsg?.msg && isPinned && pinnedUser === "user-video-1" ? "0px" : accountType === AccountType.TRAINEE && isPinned && pinnedUser === "user-video-1" ? '' :
                      isPinned ?
                        ((accountType === AccountType.TRAINER &&
                          pinnedUser === "user-video-1") ||
                          (accountType === AccountType.TRAINEE &&
                            pinnedUser === "user-video-2"))
                          ? "0% !important"
                          // ? height < 500 ? "50px" : "0% !important"
                          : (accountType === AccountType.TRAINER &&
                            pinnedUser !== "user-video-1") ||
                            (accountType === AccountType.TRAINEE &&
                              pinnedUser !== "user-video-2") ||
                            pinnedUser === null
                            ? "45% !important"
                            : "50%" :
                        "",

                  // position: displayMsg?.msg || isRemoteVideoOff ? "relative" : height < 500 ? pinnedUser === "user-video-1" ? "relative" : "absolute" : "relative",
                  position: height < 500 ? ((accountType === AccountType.TRAINER && pinnedUser === "user-video-1") || (accountType === AccountType.TRAINEE && pinnedUser === "user-video-2")) ? "relative" : "absolute" : "relative",

                  right: !((accountType === AccountType.TRAINER && pinnedUser === "user-video-1") || (accountType === AccountType.TRAINEE && pinnedUser === "user-video-2")) && height < 500 ? "-140px" : "",
                }}
                onClick={() => {
                  if (accountType === AccountType.TRAINER) {
                    if (pinnedUser === "user-video-1") {
                      emitVideoSelectEvent("swap", selectedClips, null);
                      setIsPinned(false);
                      setPinnedUser(null);
                    } else {
                      emitVideoSelectEvent("swap", selectedClips, "user-video-1");
                      setIsPinned(true);
                      setPinnedUser("user-video-1");
                    }
                  }
                }}
              >
                <video
                  ref={remoteVideoRef}
                  playsInline
                  autoPlay
                  style={{
                    width: "100%",
                    position: accountType === AccountType.TRAINER ? pinnedUser === "user-video-1" ? "relative" : "absolute" : pinnedUser === "user-video-2" ? "relative" : "absolute",
                    top: 0,
                    height:
                      !selectedClips.length &&
                        isPinned &&
                        ((accountType === AccountType.TRAINER &&
                          pinnedUser === "user-video-2") ||
                          (accountType === AccountType.TRAINEE &&
                            pinnedUser === "user-video-1"))
                        ? height < 500 ? "12vw" : "12vw"
                        : selectedClips?.length === 0 ||
                          (accountType === AccountType.TRAINER &&
                            pinnedUser === "user-video-1") ||
                          (accountType === AccountType.TRAINEE &&
                            pinnedUser === "user-video-2")
                          ? width500
                            ? "52vh"
                            : height < 500 ? (isIOS ? "52vh" : "73vh") : "73vh"
                          : height < 500 ? "12vw" : "12vw",
                    objectFit: "cover",
                    borderRadius: "10px",
                  }}
                  id="end-user-video"
                />
                <div
                  style={{
                    position: "absolute",
                    top: "0",
                    left: "0",
                    right: "0",
                    bottom: "0",
                    width: "100%",
                    // height: "100%",
                    height:
                      !selectedClips.length &&
                        isPinned &&
                        // pinnedUser === "user-video-2"
                        ((accountType === AccountType.TRAINER &&
                          pinnedUser === "user-video-2") ||
                          (accountType === AccountType.TRAINEE &&
                            pinnedUser === "user-video-1"))
                        ? height < 500 ? "12vw" : "12vw"
                        : selectedClips?.length === 0 ||
                          (accountType === AccountType.TRAINER &&
                            pinnedUser === "user-video-1") ||
                          (accountType === AccountType.TRAINEE &&
                            pinnedUser === "user-video-2")
                          ? width500
                            ? "380px"
                            : height < 500 ? "100%" : "500px"
                          : height < 500 ? "12vw" : "12vw",
                    display: "flex",
                    justifyContent: "center",
                    alignItems: "center",
                    backgroundColor: "rgb(53,53,53)",
                    borderRadius: "20px",
                    display:
                      displayMsg?.msg || isRemoteVideoOff ? "flex" : "none",
                  }}
                >
                  {toUser?.profile_picture ? (
                    <div
                      style={{
                        display: "flex",
                        flexDirection: "column",
                        gap: "5px",
                        justifyContent: "center",
                        alignItems: "center"
                      }}

                    >
                      <img
                        src={Utils.getImageUrlOfS3(toUser?.profile_picture)}
                        srcset=""
                        style={{
                          width: height < 500 ? "60px" : "100px",
                          height: height < 500 ? "60px" : "100px",
                          borderRadius:"5%"
                        }}
                      // className="container-raj"
                      />
                      <span style={{
                        color: "white"
                      }}>

                        {toUser?.fullname}
                      </span>
                    </div>
                  ) : (
                    <div
                      className="container-raj "
                      style={{
                        backgroundColor: Utils.charBasedColors(
                          Utils.capitalizeFirstChar(toUser.fullname)
                        ),
                      }}
                    >
                      <h1 className="text-box-raj">
                        {" "}
                        {getInitials(toUser?.fullname)}
                      </h1>
                    </div>
                  )}
                </div>
              </div>

              {/* User Video 2 */}

              <div
                id="user-video-2"
                className={
                  !selectedClips.length &&
                    isPinned &&
                    // pinnedUser === "user-video-2"
                    ((accountType === AccountType.TRAINER &&
                      pinnedUser === "user-video-2") ||
                      (accountType === AccountType.TRAINEE &&
                        pinnedUser === "user-video-1"))
                    ? "switch-user-video"
                    : selectedClips.length &&
                      isPinned &&
                      selectedClips.length &&
                      ((accountType === AccountType.TRAINER &&
                        pinnedUser === "user-video-2") ||
                        (accountType === AccountType.TRAINEE &&
                          pinnedUser === "user-video-1"))
                      ? "switch-user-video"
                      : mediaQuery.matches
                        ? "scs2_1"
                        : ""
                }
                style={{
                  zIndex:
                    isPinned &&
                      ((accountType === AccountType.TRAINER &&
                        pinnedUser === "user-video-2") ||
                        (accountType === AccountType.TRAINEE &&
                          pinnedUser === "user-video-1"))
                      ? "auto"
                      : 999,
                  width: !isPinned ? '25%  ' : accountType === AccountType.TRAINER ? isPinned && pinnedUser === "user-video-2" ? '' : '25%' : isPinned && pinnedUser === "user-video-1" ? '' : '25%',
                  marginTop: accountType === AccountType.TRAINER && isPinned && pinnedUser === "user-video-2" ? '10px' : accountType === AccountType.TRAINEE && isPinned && pinnedUser === "user-video-1" ? '10px' : accountType === AccountType.TRAINEE && displayMsg?.msg && isPinned &&
                    pinnedUser === "user-video-1" ? '0px' : displayMsg?.msg && isPinned &&
                      pinnedUser === "user-video-2" ? '0px' : accountType === AccountType.TRAINER ? isPinned &&
                        pinnedUser === "user-video-2" ? '50px' : ''
                    :
                    // trainee
                    !isPinned && selectedClips?.length ? '50px' :
                      pinnedUser === "user-video-2" ? "" : "50px",

                  top: accountType === AccountType.TRAINER ? "" :
                    // trainee
                    !isPinned && selectedClips?.length ? '0px' : ''
                  ,
                  height: accountType === AccountType.TRAINER && isPinned && pinnedUser === "user-video-2" ?(isIOS ? "52vh" : "73vh") :
                    isPinned &&
                      ((accountType === AccountType.TRAINER &&
                        pinnedUser === "user-video-2") ||
                        (accountType === AccountType.TRAINEE &&
                          pinnedUser === "user-video-1"))
                      ? width500
                        ? (isIOS ? "52vh" : "73vh")
                        : height < 500 ?  (isIOS ? "52vh" : "73vh")  :  (isIOS ? "52vh" : "73vh") 
                      : width500
                        ? "12vw"
                        : height < 500 ? "12vw" : "12vw",
                  // top :  selectedClips.length > 0 ?  "10% !important" : "20%"
                  top: accountType === AccountType.TRAINEE && displayMsg?.msg && isPinned &&
                    pinnedUser === "user-video-2" ? width900 ?'20px':'110px' : displayMsg?.msg && isPinned &&
                      pinnedUser === "user-video-1" ? width900 ?'20px':'110px' : displayMsg?.msg && isPinned &&
                        pinnedUser === "user-video-2" ? "0px" :
                    accountType === AccountType.TRAINEE && !isPinned && selectedClips?.length ? '0px' :
                      isPinned && !(height < 500) ?
                        ((accountType === AccountType.TRAINER && pinnedUser === "user-video-2") || (accountType === AccountType.TRAINEE && pinnedUser === "user-video-1"))
                          ? "0% !important"
                          : (accountType === AccountType.TRAINER && pinnedUser !== "user-video-2") || (accountType === AccountType.TRAINEE && pinnedUser !== "user-video-1") || pinnedUser === null
                            ? "10% !important" : "20%"
                        : height < 500 ? !((accountType === AccountType.TRAINER && pinnedUser === "user-video-2") || (accountType === AccountType.TRAINEE && pinnedUser === "user-video-1")) ? "50px" : "" : "",

                  position: height < 500 ?
                    ((accountType === AccountType.TRAINER && pinnedUser === "user-video-2")
                      || (accountType === AccountType.TRAINEE && pinnedUser === "user-video-1")
                    ) ?
                      "relative" : "absolute" : "relative",
                  right: !((accountType === AccountType.TRAINER && pinnedUser === "user-video-2") || (accountType === AccountType.TRAINEE && pinnedUser === "user-video-1")) && height < 500 ? "-140px" : "",
                }}
                onClick={() => {
                  if (accountType === AccountType.TRAINER) {
                    if (pinnedUser === "user-video-2") {
                      emitVideoSelectEvent("swap", selectedClips, null);
                      setIsPinned(false);
                      setPinnedUser(null);
                    } else {
                      emitVideoSelectEvent("swap", selectedClips, "user-video-2");
                      setIsPinned(true);
                      setPinnedUser("user-video-2");
                    }
                  }
                }}
              >
                <video
                  id="end-user-video"
                  playsInline
                  muted
                  style={{
                    position: accountType === AccountType.TRAINER ? pinnedUser === "user-video-2" ? "relative" : "absolute" : pinnedUser === "user-video-1" ? "relative" : "absolute",
                    top: (isIOS ? "0" : accountType.trainer ? "10px" : "0"),
                    width: "100%",
                    height:
                      isPinned &&
                        ((accountType === AccountType.TRAINER &&
                          pinnedUser === "user-video-2") ||
                          (accountType === AccountType.TRAINEE &&
                            pinnedUser === "user-video-1"))
                        ? width500
                          ? "380px"
                          : height < 500 ? "100%" : "500px"
                        : width500
                          ? "150px"
                          : height < 500 ? "12vw" : "12vw",
                    objectFit: "cover",
                    borderRadius: "10px",
                  }}
                  ref={videoRef}
                  autoPlay
                />
                <div
                  style={{
                    position: "absolute",
                    top: "0%",
                    left: "0%",
                    right: "0%",
                    bottom: "0%",
                    width: "100%",
                    // height: "100%",
                    height:
                      isPinned &&
                        ((accountType === AccountType.TRAINER &&
                          pinnedUser === "user-video-2") ||
                          (accountType === AccountType.TRAINEE &&
                            pinnedUser === "user-video-1"))
                        ? width500
                          ? "380px"
                          : height < 500 ? "100%" : "500px"
                        : width500
                          ? "150px"
                          : height < 500 ? "12vw" : "12vw",
                    display: isFeedStopped ? "flex" : "none",
                    justifyContent: "center",
                    alignItems: "center",
                    backgroundColor: "rgb(53,53,53)",
                    borderRadius: "20px",
                  }}
                >
                  {fromUser?.profile_picture ? (
                    <div
                      style={{
                        display: "flex",
                        flexDirection: "column",
                        gap: "5px",
                        justifyContent: "center",
                        alignItems: "center"
                      }}

                    >
                      <img
                        src={Utils.getImageUrlOfS3(fromUser?.profile_picture)}
                        srcset=""
                        style={{
                          width: height < 500 ? "60px" : "100px",
                          height: height < 500 ? "60px" : "100px",
                          borderRadius:"5%"  
                        }}
                      // className="container-raj"
                      />
                      <span style={{
                        color: "white"
                      }}>

                        {fromUser?.fullname}
                      </span>
                    </div>
                  ) : (
                    <div
                      className="container-raj"
                      style={{
                        backgroundColor: Utils.charBasedColors(
                          Utils.capitalizeFirstChar(fromUser.fullname)
                        ),
                      }}
                    >
                      <h1 className="text-box-raj">
                        {" "}
                        {getInitials(fromUser.fullname)}
                      </h1>
                    </div>
                  )}
                </div>
              </div>

              {renderCallActionButtons()}
            </div>
          }

          <ReportModal
            currentReportData={{
              session: id,
              trainer: fromUser?._id,
              trainee: toUser?._id,
            }}
            isOpenReport={isOpenReport}
            setIsOpenReport={setIsOpenReport}
            screenShots={screenShots}
            setScreenShots={setScreenShots}
            // setScreenShots={setScreenShot}
            reportObj={reportObj}
            setReportObj={setReportObj}
            isClose={isClose}
            isTraineeJoined={isTraineeJoined}
            isCallEnded={isCallEnded}
          />

          <Modal isOpen={isModelOpen}>
            <ModalHeader>
              <h2>Recording</h2>
            </ModalHeader>
            <ModalBody>
              <div className="row">
                <Button
                  className="mx-3 mt-1"
                  color="primary"
                  onClick={() => {
                    startRecording();
                    setIsModelOpen(false);
                  }}
                >
                  Start Recording
                </Button>
                <Button
                  className="mx-3 mt-1"
                  color="primary"
                  onClick={() => {
                    setIsModelOpen(false);
                  }}
                >
                  Cancel
                </Button>
              </div>
            </ModalBody>
          </Modal>
        </div>
        {isScreenShotModelOpen && (
          
          <ScreenShotDetails
            screenShotImages={screenShots}
            setScreenShotImages={setScreenShots}
            setIsOpenDetail={setIsScreenShotModelOpen}
            isOpenDetail={isScreenShotModelOpen}
            currentReportData={{
              session: id,
              trainer: fromUser?._id,
              trainee: toUser?._id,
            }}
            reportObj={reportObj}
          />
        )}

        <PermissionModal isOpen={permissionModal} />
      </React.Fragment>
    );
  } else {
    return (
      <React.Fragment>
        <Script
          src="https://vjs.zencdn.net/7.20.3/video.min.js"
          strategy="lazyOnload"
        />
        <OrientationModal isOpen={modal} />
        <div
          className="row"
          style={{ height: "100%", display: "flex", alignItems: "center" }}
        >
          {/* 1 */}
          {accountType === AccountType.TRAINER ? (
            <div className="col-lg-1 col-md-1 col-sm-2 z-50"
            // style={{ flex: '0 0 9px', width: '9px', }}
            >
              <div>
                <CanvasMenuBar
                  isOpen={isOpen}
                  setIsOpen={setIsOpen}
                  setSketchPickerColor={(rgb) => {
                    setSketchPickerColor(rgb);
                  }}
                  undoDrawing={() => {
                    undoDrawing(
                      {
                        coordinates: storedLocalDrawPaths.sender,
                        theme: canvasConfigs.sender,
                      },
                      {
                        coordinates: storedLocalDrawPaths.receiver,
                        theme: {
                          lineWidth: canvasConfigs.receiver.lineWidth,
                          strokeStyle: canvasConfigs.receiver.strokeStyle,
                        },
                      }
                    );
                  }}
                  sketchPickerColor={sketchPickerColor}
                  canvasConfigs={canvasConfigs}
                  setCanvasConfigs={(config) => {
                    canvasConfigs = config;
                  }}
                  drawShapes={(shapeType) => {
                    selectedShape = shapeType;
                  }}
                  refreshDrawing={() => {
                    // deleting the canvas drawing
                    storedLocalDrawPaths.sender = [];
                    storedLocalDrawPaths.receiver = [];
                    clearCanvas();
                    sendClearCanvasEvent();
                  }}
                  selectedClips={selectedClips}
                  setSelectedClips={setSelectedClips}
                  toUser={toUser}
                  isCanvasMenuNoteShow={isCanvasMenuNoteShow}
                  setIsCanvasMenuNoteShow={setIsCanvasMenuNoteShow}
                  setMicNote={setMicNote}
                  setClipSelectNote={setClipSelectNote}
                  clipSelectNote={clipSelectNote}
                  setCountClipNoteOpen={setCountClipNoteOpen}
                  resetInitialPinnedUser={resetInitialPinnedUser}
                />
              </div>
            </div>
          ) : (
            <div className="col-lg-1 col-md-6 col-sm-2 " ></div>
          )}

          {/* 2 */}

          {
            <div
              className="col-lg-8 col-md-8 col-sm-12 "
              id="third"
              style={{
                height: "100%",
                display: "flex",
                alignItems: "center",
                justifyContent: "space-evenly",
                flexDirection: "column",
                // top: height < 500 ? "-63px" : ""
              }}
            >
              {displayMsg?.msg ? (
                <div
                  className="no-user-joined font-weight-bold text-center"
                  style={{
                    margin: displayMsg?.msg ? (width1000 ? "0px" : "10px") : "",
                    zIndex: displayMsg?.msg ? 8 : 1,
                    fontSize: width1000 ? "14px" : "20px",
                  }}
                >
                  {displayMsg?.msg}
                </div>
              ) : null}
              <canvas
                ref={canvasRef}
                id="drawing-canvas"
                width={document.getElementById("third")?.clientWidth}
                height={document.getElementById("drawing-canvas")?.clientHeight}
                className="canvas-print absolute all-0"
                style={{ margin: 'auto', height: isPinned ? "500px" : "69vh", width: '100%' }}
              />
              {selectedClips?.length ? (
                <div
                  id="clips-container-id"
                  className={
                    isPinned
                      ? accountType === AccountType.TRAINER
                        ? pinnedUser === "user-video-1"
                          ? height < 500 ? "switch-clips-container-for-mobile" : "switch-clips-container"
                          : height < 500 ? "scs2-mobile" : "scs2"
                        : accountType === AccountType.TRAINEE &&
                          pinnedUser === "user-video-1"
                          ? height < 500 ? "scs2-mobile" : "scs2"
                          : height < 500 ? "switch-clips-container-for-mobile" : "switch-clips-container"
                      : "row"
                  }
                  style={{
                    zIndex: isPinned ? "999" : "auto",
                    backgroundColor: isPinned ? "#353535" : "",
                    borderRadius: isPinned ? "10px" : "",
                    padding: isPinned ? "5px" : "",
                    position:'relative'
                  }}
                  onClick={() => {
                    if (accountType === AccountType.TRAINER) {
                      emitVideoSelectEvent("swap", selectedClips, null);
                      setPinnedUser(null);
                      setIsPinned(false);
                    }
                  }}
                >
                  <div
                    className="row"
                    style={
                      mediaQuery.matches
                        ? selectedClips?.length === 1
                          ? isOnlyOneVideo
                          : isTwoVideos
                        : {}
                    }
                  >
                    {selectedClips.length && selectedClips[0] ? (
                      <div
                        className="col-lg-6 col-md-6 col-sm-6 col-xs-12"
                        style={{
                          // padding: "1px !important",
                          height: "100%",
                          paddingRight: 0,
                        }}
                      >
                        {/* {
                          showThumbnailForFirstVideo ?
                            <img
                              src={Utils?.generateThumbnailURL(selectedClips[0])}
                              id="selected-video-1"
                              style={{
                                height: isPinned ? "100%" : "34.5vw",
                                width: "100%",
                                objectFit: "cover",
                              }}
                              loading="lazy"
                            />
                            :
                            <video
                              // crossOrigin="anonymous"
                              poster={Utils?.generateThumbnailURL(selectedClips[0])}
                              id="selected-video-1"
                              style={{
                                height: isPinned ? "100%" : "34.5vw",
                                // width: "inherit",
                                // borderRadius: 10,
                                width: "100%",
                                objectFit: "cover",
                              }}
                              ref={selectedVideoRef1}
                              onTimeUpdate={handleTimeUpdate1}
                              onCanPlay={() => canPlayVideo(Utils.generateVideoURL2(selectedClips[0]))}
                            >

                              <source src={Utils.generateVideoURL2(selectedClips[0])} type="video/mp4" />
                              <source src={Utils.generateVideoURL2(selectedClips[0])} type="video/webm" />
                            </video>
                        } */}

                        <LazyVideo
                          id="selected-video-1"
                          style={{
                            height: "95%",
                            width: "100%",
                            objectFit: "cover",
                          }}
                          ref={selectedVideoRef1}
                          onTimeUpdate={handleTimeUpdate1}
                          poster={Utils?.generateThumbnailURL(selectedClips[0])}
                          src={Utils?.generateVideoURL(selectedClips[0])}
                        />
                        {/* <canvas id="video-canvas-1" hidden></canvas> */}
    
                        {accountType === AccountType.TRAINER &&
                          !videoController &&
                          !isPinned && (
                            <>
                              <div
                                className="Pause"
                                style={{
                                  position: "relative",
                                  zIndex: 10,
                                  display: "flex",
                                  justifyContent: "center",
                                  alignItems: "center",
                                }}
                              >
                                <div>
                                  <p style={{ margin: 0, marginRight: "10px" }}>
                                    {videoTime?.currentTime1}
                                  </p>{" "}
                                </div>
                                <div className="external-control-bar">
                                  <button
                                    className="btn btn-primary px-1 py-1 my-3 mr-2"
                                    onClick={() => {
                                      togglePlay("one");
                                      handlePlayClick()
                                    }}
                                  >
                                    {isPlaying?.isPlaying1 ? (
                                      <Pause
                                        style={{ verticalAlign: "middle" }}
                                      />
                                    ) : (
                                      <Play style={{ verticalAlign: "middle" }} />
                                    )}
                                  </button>
                                </div>

                                {/* UI changed of video time slider and made it on onChange effect  */}

                                <input
                                  type="range"
                                  ref={progressBarRef}
                                  step="0.01"
                                  value={
                                    selectedVideoRef1.current?.currentTime || 0
                                  }
                                  max={selectedVideoRef1.current?.duration || 100}
                                  onChange={(e) =>
                                    handleProgressBarChange(e, "one")
                                  }
                                />
                                <div>
                                  <p
                                    style={{
                                      margin: 0,
                                      marginLeft: "10px",
                                      fontSize: "16px",
                                    }}
                                  >
                                    {videoTime?.remainingTime1}
                                  </p>{" "}
                                </div>
                              </div>
                            </>
                          )}
                      </div>
                    ) : null}
                    {selectedClips.length && selectedClips[1] ? (
                      <div
                        className="col-lg-6 col-md-6 col-sm-6 col-xs-12"
                        style={{
                          // padding: "1px",
                          height: "100%",
                          paddingLeft: 0,
                        }}
                      >
                        {/* {
                          showThumbnailForFirstVideo ?
                            <img
                              src={Utils?.generateThumbnailURL(selectedClips[1])}
                              id="selected-video-1"
                              style={{
                                height: isPinned ? "100%" : "34.5vw",
                                width: "100%",
                                objectFit: "cover",
                              }}
                              loading="lazy"
                            />
                            :
                            <video
                              // crossOrigin="anonymous"
                              id="selected-video-2"
                              style={{
                                height: isPinned ? "100%" : "34.5vw",
                                // width: "inherit",
                                // borderRadius: 10,
                                width: "100%",
                                objectFit: "cover",
                              }}
                              ref={selectedVideoRef2}
                              onTimeUpdate={handleTimeUpdate2}
                              poster={Utils?.generateThumbnailURL(selectedClips[1])}
                            >
                              <source
                                src={Utils?.generateVideoURL(selectedClips[1])}
                                type="video/mp4"
                              />
                            </video>
                        } */}

                        <LazyVideo
                          id="selected-video-2"
                          style={{
                            height: "95%",
                            width: "100%",
                            objectFit: "cover",
                          }}
                          ref={selectedVideoRef2}
                          onTimeUpdate={handleTimeUpdate2}
                          poster={Utils?.generateThumbnailURL(selectedClips[1])}
                          src={Utils?.generateVideoURL(selectedClips[1])}
                        />
                        {/* <canvas id="video-canvas-2" hidden></canvas> */}
                        {accountType === AccountType.TRAINER &&
                          !videoController &&
                          !isPinned && (
                            <>
                              <div
                                className="Pause2"
                                style={{
                                  position: "relative",
                                  zIndex: 10,
                                  display: "flex",
                                  justifyContent: "center",
                                  alignItems: "center",
                                }}
                              >
                                <div>
                                  <p style={{ margin: 0, marginRight: "10px" }}>
                                    {videoTime?.currentTime2}
                                  </p>{" "}
                                </div>
                                <div className="external-control-bar">
                                  <button
                                    className="btn btn-primary px-1 py-1 my-3 mr-2 "
                                    onClick={() => togglePlay("two")}
                                  >
                                    {isPlaying?.isPlaying2 ? (
                                      <Pause
                                        style={{ verticalAlign: "middle" }}
                                      />
                                    ) : (
                                      <Play style={{ verticalAlign: "middle" }} />
                                    )}
                                  </button>
                                </div>
                                {/* <progress
                            className="progress"
                            ref={progressBarRef2}
                            value="0"
                            max={
                              selectedVideoRef2.current
                                ? selectedVideoRef2.current.duration
                                : 100
                            }
                            onClick={(e) => handleProgressBarClick(e, "two")}
                          /> */}

                                {/* UI changed of video time slider and made it on onChange effect  */}
                                <input
                                  type="range"
                                  // className="progress"
                                  ref={progressBarRef2}
                                  step="0.01"
                                  value={
                                    selectedVideoRef2.current?.currentTime || 0
                                  }
                                  max={selectedVideoRef2.current?.duration || 100}
                                  onChange={(e) =>
                                    handleProgressBarChange(e, "two")
                                  }
                                />
                                <div>
                                  <p style={{ margin: 0, marginLeft: "10px" }}>
                                    {videoTime?.remainingTime2}
                                  </p>{" "}
                                </div>
                              </div>
                              {/* commented volume rannge  for now */}
                              {/* <div
                          className="progress2"
                          style={{
                            position: "relative",
                            zIndex: 10,
                            display: "flex",
                            justifyContent: "space-between",
                            alignItems: "center",
                          }}
                        >
                          <div>
                            <p style={{ margin: 0, marginRight: "10px" }}>
                              Volume
                            </p>{" "}
                          </div>
                          <input
                            className="progress"
                            ref={volumeInputRef2}
                            type="range"
                            min="0"
                            max="1"
                            step="0.1"
                            value={volume2}
                            onChange={handleVolumeChange2}
                          />
                        </div> */}
                            </>
                          )}
                      </div>
                    ) : null}
                  </div>
                  {accountType === AccountType.TRAINER &&
                    videoController &&
                    !isPinned && (
                      <>
                        <div
                          className="Pause"
                          style={{
                            position: "relative",
                            zIndex: 10,
                            display: "flex",
                            justifyContent: "center",
                            alignItems: "center",
                            marginInline: "auto",
                          }}
                        >
                          {/* <div>
                            <p style={{ margin: 0, marginRight: "10px" }}>
                              {videoTime?.currentTime1}
                            </p>{" "}
                          </div> */}
                          <div className="external-control-bar">
                            <button
                              className="btn btn-primary px-1 py-1 my-3 mr-2"
                              onClick={() => togglePlay("all")}
                            >
                              {isPlaying?.isPlayingAll ? (
                                <Pause style={{ verticalAlign: "middle" }} />
                              ) : (
                                <Play style={{ verticalAlign: "middle" }} />
                              )}
                            </button>
                          </div>
                          <input
                            type="range"
                            ref={globalProgressBarRef}
                            step="0.01"
                            value={
                              (selectedVideoRef1.current?.currentTime || 0) >
                                (selectedVideoRef2.current?.currentTime || 0)
                                ? selectedVideoRef1.current?.currentTime || 0
                                : selectedVideoRef2.current?.currentTime || 0
                            }
                            max={
                              (selectedVideoRef1.current?.duration || 0) >
                                (selectedVideoRef2.current?.duration || 0)
                                ? selectedVideoRef1.current?.duration || 0
                                : selectedVideoRef2.current?.duration || 0
                            }
                            onChange={handleGlobalProgressBarChange}
                            style={{ width: "450px" }}
                          />
                          {/* <div>
                            <p style={{ margin: 0, marginLeft: "10px" }}>
                              {videoTime?.remainingTime1}
                            </p>{" "}
                          </div> */}
                        </div>
                      </>
                    )}
                </div>
              ) : null}

              {/* Timer  */}
              {isTraineeJoined &&
              <div
                id="sessionEndTime"
                style={{
                  position: "absolute",
                  top: width768 ? (!displayMsg?.msg ? "1%" : "10%") : "3%",
                  right: width768 ? "30%" : "-29%",
                  zIndex: 999,
                }}
              >
                <div
                  className="text-center"
                  style={{
                    display: "flex",
                    fontSize: "12px",
                    justifyContent: "center",
                    alignItems: "center",
                    flexDirection: 'column'
                  }}
                >
                  <h3>Time remaining</h3>
                  <h2 style={{ fontSize: "18px" }}> {timeDifference}</h2>
                </div>
              </div>}

              {/* User Video 1 */}

              <div
                id="user-video-1"
                className={
                  !selectedClips.length &&
                    isPinned &&
                    ((accountType === AccountType.TRAINER &&
                      pinnedUser === "user-video-2") ||
                      (accountType === AccountType.TRAINEE &&
                        pinnedUser === "user-video-1"))
                    ? // pinnedUser === "user-video-2"
                    "scs2"
                    : !selectedClips.length &&
                      isPinned &&
                      // pinnedUser === "user-video-1"
                      ((accountType === AccountType.TRAINER &&
                        pinnedUser === "user-video-1") ||
                        (accountType === AccountType.TRAINEE &&
                          pinnedUser === "user-video-2"))
                      ? "switch-user-video"
                      : selectedClips.length &&
                        isPinned &&
                        selectedClips.length &&
                        ((accountType === AccountType.TRAINER &&
                          pinnedUser === "user-video-1") ||
                          (accountType === AccountType.TRAINEE &&
                            pinnedUser === "user-video-2"))
                        ? "switch-user-video"
                        : selectedClips?.length !== 0 && mediaQuery.matches
                          ? "scs"
                          : ""
                }
                style={{
                  zIndex:
                    !selectedClips.length &&
                      isPinned &&
                      // pinnedUser === "user-video-2"
                      ((accountType === AccountType.TRAINER &&
                        pinnedUser === "user-video-2") ||
                        (accountType === AccountType.TRAINEE &&
                          pinnedUser === "user-video-1"))
                      ? "999"
                      : selectedClips?.length &&
                        ((accountType === AccountType.TRAINER &&
                          pinnedUser !== "user-video-1") ||
                          (accountType === AccountType.TRAINEE &&
                            pinnedUser !== "user-video-2")) &&
                        isPinned
                        ? 999
                        : selectedClips?.length && !pinnedUser && !isPinned
                          ? 999
                          : "auto",
                  height:
                    !selectedClips.length &&
                      isPinned &&
                      // pinnedUser === "user-video-2"
                      ((accountType === AccountType.TRAINER &&
                        pinnedUser === "user-video-2") ||
                        (accountType === AccountType.TRAINEE &&
                          pinnedUser === "user-video-1"))
                      ? height < 500 ? "80px" : ""
                      : selectedClips?.length === 0 ||
                        (accountType === AccountType.TRAINER &&
                          pinnedUser === "user-video-1") ||
                        (accountType === AccountType.TRAINEE &&
                          pinnedUser === "user-video-2")
                        ? width500
                          ? "380px"
                          : height < 500 ? "100%" : "500px"
                        : height < 500 ? "80px" : "",
                  marginTop: width768 ? (width500 ? "40px" : "50px") : "20px",
                  top:
                    isPinned ?
                      ((accountType === AccountType.TRAINER &&
                        pinnedUser === "user-video-1") ||
                        (accountType === AccountType.TRAINEE &&
                          pinnedUser === "user-video-2"))
                        ? "0% !important"
                        // ? height < 500 ? "50px" : "0% !important"
                        : (accountType === AccountType.TRAINER &&
                          pinnedUser !== "user-video-1") ||
                          (accountType === AccountType.TRAINEE &&
                            pinnedUser !== "user-video-2") ||
                          pinnedUser === null
                          ? "45% !important"
                          : "50%" :
                      "",

                  // position: displayMsg?.msg || isRemoteVideoOff ? "relative" : height < 500 ? pinnedUser === "user-video-1" ? "relative" : "absolute" : "relative",
                  position: height < 500 ? ((accountType === AccountType.TRAINER && pinnedUser === "user-video-1") || (accountType === AccountType.TRAINEE && pinnedUser === "user-video-2")) ? "relative" : "absolute" : "relative",

                  right: !((accountType === AccountType.TRAINER && pinnedUser === "user-video-1") || (accountType === AccountType.TRAINEE && pinnedUser === "user-video-2")) && height < 500 ? "-140px" : "",
                }}
                onClick={() => {
                  if (accountType === AccountType.TRAINER) {
                    if (pinnedUser === "user-video-1") {
                      emitVideoSelectEvent("swap", selectedClips, null);
                      setIsPinned(false);
                      setPinnedUser(null);
                    } else {
                      emitVideoSelectEvent("swap", selectedClips, "user-video-1");
                      setIsPinned(true);
                      setPinnedUser("user-video-1");
                    }
                  }
                }}
              >
                <video
                  ref={remoteVideoRef}
                  playsInline
                  autoPlay
                  style={{
                    width: "100%",
                    height: "100%",
                    objectFit: "cover",
                    borderRadius: "10px",
                  }}
                  id="end-user-video"
                />
                <div
                  style={{
                    position: "absolute",
                    top: "0",
                    left: "0",
                    right: "0",
                    bottom: "0",
                    width: "100%",
                    height: "100%",
                    display: "flex",
                    justifyContent: "center",
                    alignItems: "center",
                    height: "100%",
                    backgroundColor: "rgb(53,53,53)",
                    borderRadius: "20px",
                    display:
                      displayMsg?.msg || isRemoteVideoOff ? "flex" : "none",
                  }}
                >
                  {toUser?.profile_picture ? (
                    <div
                      style={{
                        display: "flex",
                        flexDirection: "column",
                        gap: "5px",
                        justifyContent: "center",
                        alignItems: "center"
                      }}

                    >
                      <img
                        src={Utils.getImageUrlOfS3(toUser?.profile_picture)}
                        srcset=""
                        style={{
                          width: height < 500 ? "60px" : "100px",
                          height: height < 500 ? "60px" : "100px",
                          borderRadius:"5%"
                        }}
                      // className="container-raj"
                      />
                      <span style={{
                        color: "white"
                      }}>

                        {toUser?.fullname}
                      </span>
                    </div>
                  ) : (
                    <div
                      className="container-raj "
                      style={{
                        backgroundColor: Utils.charBasedColors(
                          Utils.capitalizeFirstChar(toUser.fullname)
                        ),
                      }}
                    >
                      <h1 className="text-box-raj">
                        {" "}
                        {getInitials(toUser?.fullname)}
                      </h1>
                    </div>
                  )}
                </div>
              </div>

              {/* User Video 2 */}

              <div
                id="user-video-2"
                className={
                  !selectedClips.length &&
                    isPinned &&
                    // pinnedUser === "user-video-2"
                    ((accountType === AccountType.TRAINER &&
                      pinnedUser === "user-video-2") ||
                      (accountType === AccountType.TRAINEE &&
                        pinnedUser === "user-video-1"))
                    ? "switch-user-video"
                    : selectedClips.length &&
                      isPinned &&
                      selectedClips.length &&
                      ((accountType === AccountType.TRAINER &&
                        pinnedUser === "user-video-2") ||
                        (accountType === AccountType.TRAINEE &&
                          pinnedUser === "user-video-1"))
                      ? "switch-user-video"
                      : mediaQuery.matches
                        ? "scs2"
                        : ""
                }
                style={{
                  zIndex:
                    isPinned &&
                      ((accountType === AccountType.TRAINER &&
                        pinnedUser === "user-video-2") ||
                        (accountType === AccountType.TRAINEE &&
                          pinnedUser === "user-video-1"))
                      ? "auto"
                      : 999,

                  marginLeft:'auto',
                  marginRight:'auto',
                  marginTop: (!isMobile && accountType.trainee ? "20px" : ""),
                  height:
                    isPinned &&
                      ((accountType === AccountType.TRAINER &&
                        pinnedUser === "user-video-2") ||
                        (accountType === AccountType.TRAINEE &&
                          pinnedUser === "user-video-1"))
                      ? width500
                        ? "380px"
                        : height < 500 ? "100%" : "500px"
                      : width500
                        ? "150px"
                        : height < 500 ? "80px" : "",
                  // top :  selectedClips.length > 0 ?  "10% !important" : "20%"
                  top:
                    isPinned && !(height < 500) ?
                      ((accountType === AccountType.TRAINER && pinnedUser === "user-video-2") || (accountType === AccountType.TRAINEE && pinnedUser === "user-video-1"))
                        ? "0% !important"
                        : (accountType === AccountType.TRAINER && pinnedUser !== "user-video-2") || (accountType === AccountType.TRAINEE && pinnedUser !== "user-video-1") || pinnedUser === null
                          ? "10% !important" : "20%"
                      : height < 500 ? !((accountType === AccountType.TRAINER && pinnedUser === "user-video-2") || (accountType === AccountType.TRAINEE && pinnedUser === "user-video-1")) ? "50px" : "" : "",

                  position: height < 500 ?
                    ((accountType === AccountType.TRAINER && pinnedUser === "user-video-2")
                      || (accountType === AccountType.TRAINEE && pinnedUser === "user-video-1")
                    ) ?
                      "relative" : "absolute" : "relative",
                  right: !((accountType === AccountType.TRAINER && pinnedUser === "user-video-2") || (accountType === AccountType.TRAINEE && pinnedUser === "user-video-1")) && height < 500 ? "-140px" : "",
                }}
                onClick={() => {
                  if (accountType === AccountType.TRAINER) {
                    if (pinnedUser === "user-video-2") {
                      emitVideoSelectEvent("swap", selectedClips, null);
                      setIsPinned(false);
                      setPinnedUser(null);
                    } else {
                      emitVideoSelectEvent("swap", selectedClips, "user-video-2");
                      setIsPinned(true);
                      setPinnedUser("user-video-2");
                    }
                  }
                }}
              >
                <video
                  id="end-user-video"
                  playsInline
                  muted
                  // className="rounded "
                  style={{
                    width: "100%",
                    height: "100%",
                    objectFit: "cover",
                    borderRadius: "10px",
                  }}
                  ref={videoRef}
                  autoPlay
                />
                <div
                  style={{
                    position: "absolute",
                    top: "0%",
                    left: "0%",
                    right: "0%",
                    bottom: "0%",
                    width: "100%",
                    height: "100%",
                    display: isFeedStopped ? "flex" : "none",
                    justifyContent: "center",
                    alignItems: "center",
                    backgroundColor: "rgb(53,53,53)",
                    borderRadius: "20px",
                  }}
                >
                  {fromUser.profile_picture ? (
                    <div
                      style={{
                        display: "flex",
                        flexDirection: "column",
                        gap: "5px",
                        justifyContent: "center",
                        alignItems: "center"
                      }}

                    >
                      <img
                        src={Utils.getImageUrlOfS3(fromUser?.profile_picture)}
                        srcset=""
                        style={{
                          width: height < 500 ? "60px" : "100px",
                          height: height < 500 ? "60px" : "100px",
                          borderRadius:"5%"
                        }}
                      // className="container-raj"
                      />
                      <span style={{
                        color: "white"
                      }}>

                        {fromUser?.fullname}
                      </span>
                    </div>
                  ) : (
                    <div
                      className="container-raj"
                      style={{
                        backgroundColor: Utils.charBasedColors(
                          Utils.capitalizeFirstChar(fromUser.fullname)
                        ),
                      }}
                    >
                      <h1 className="text-box-raj">
                        {" "}
                        {getInitials(fromUser.fullname)}
                      </h1>
                    </div>
                  )}
                </div>
              </div>

              {renderCallActionButtons()}
            </div>
          }

          <ReportModal
            currentReportData={{
              session: id,
              trainer: fromUser?._id,
              trainee: toUser?._id,
            }}
            isOpenReport={isOpenReport}
            setIsOpenReport={setIsOpenReport}
            screenShots={screenShots}
            setScreenShots={setScreenShots}
            // setScreenShots={setScreenShot}
            reportObj={reportObj}
            setReportObj={setReportObj}
            isClose={isClose}
            isTraineeJoined={isTraineeJoined}
            isCallEnded={isCallEnded}
          />

          <Modal isOpen={isModelOpen}>
            <ModalHeader>
              <h2>Recording</h2>
            </ModalHeader>
            <ModalBody>
              <div className="row">
                <Button
                  className="mx-3 mt-1"
                  color="primary"
                  onClick={() => {
                    startRecording();
                    setIsModelOpen(false);
                  }}
                >
                  Start Recording
                </Button>
                <Button
                  className="mx-3 mt-1"
                  color="primary"
                  onClick={() => {
                    setIsModelOpen(false);
                  }}
                >
                  Cancel
                </Button>
              </div>
            </ModalBody>
          </Modal>
        </div>
        {isScreenShotModelOpen && (
          <ScreenShotDetails
            screenShotImages={screenShots}
            setScreenShotImages={setScreenShots}
            setIsOpenDetail={setIsScreenShotModelOpen}
            isOpenDetail={isScreenShotModelOpen}
            currentReportData={{
              session: id,
              trainer: fromUser?._id,
              trainee: toUser?._id,
            }}
            reportObj={reportObj}
          />
        )}

        <PermissionModal isOpen={permissionModal} />
      </React.Fragment>
    );
  }
};