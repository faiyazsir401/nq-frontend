import React, { useContext, useEffect, useState } from "react";
import { useAppDispatch, useAppSelector } from "../../store";
import {
  addTraineeClipInBookedSessionAsync,
  bookingsState,
  getScheduledMeetingDetailsAsync,
  updateBookedSessionScheduledMeetingAsync,
} from "../common/common.slice";
import { CovertTimeAccordingToTimeZone, navigateToMeeting, Utils } from "../../../utils/utils";
import {
  AccountType,
  BookedSession,
  bookingButton,
} from "../../common/constants";
import { authState } from "../auth/auth.slice";
import { Button } from "reactstrap";
import { X } from "react-feather";
import Modal from "../../common/modal";
import { traineeAction } from "../trainee/trainee.slice";
import AddClip from "./start/AddClip";
import { commonState } from "../../common/common.slice";
import { SocketContext } from "../socket";
import { EVENTS } from "../../../helpers/events";
import { notificiationTitles } from "../../../utils/constant";
import { DateTime } from "luxon";
import { useMediaQuery } from "usehooks-ts";

const TraineeRenderBooking = ({
  _id,
  status,
  trainee_info,
  trainer_info,
  isCurrentDateBefore,
  isStartButtonEnabled,
  isMeetingDone,
  isUpcomingSession,
  ratings,
  booking_index,
  has24HoursPassedSinceBooking,
  isOpen,
  setIsOpen,
  selectedClips,
  setSelectedClips,
  setIsOpenID,
  isOpenID,
  addTraineeClipInBookedSession,
  trainee_clips,
  report,
  bookedSession,
  setBookedSession,
  tabBook,
  startMeeting,
  setStartMeeting,
  updateParentState,
  handleAddRatingModelState,
  accountType,
  activeTabs,
  start_time,
  bookingInfo
}) => {
  const { scheduledMeetingDetails, addRatingModel } =
    useAppSelector(bookingsState);
  const socket = useContext(SocketContext);
  const { clips } = useAppSelector(commonState);
  const dispatch = useAppDispatch();
  const { removeNewBookingData } = traineeAction;
  const isCompleted =
    has24HoursPassedSinceBooking || bookingInfo?.ratings?.trainee;

    const currentTime = DateTime.now(); // Use UTC to avoid timezone mismatch

    // Parse the start_time and end_time in UTC
    const startTime = DateTime.fromISO(bookingInfo.start_time, { zone: 'utc' });
    const endTime = DateTime.fromISO(bookingInfo.end_time, { zone: 'utc' });
    
    // Extract date and time components
    const currentDate = currentTime.toFormat('yyyy-MM-dd');  // YYYY-MM-DD format
    const currentTimeOnly = currentTime.toFormat('HH:mm');  // HH:mm format
  
    const startDate = startTime.toFormat('yyyy-MM-dd');
    const startTimeOnly = startTime.toFormat('HH:mm');
  
    const endDate = endTime.toFormat('yyyy-MM-dd');
    const endTimeOnly = endTime.toFormat('HH:mm');
  
    // Compare the current date and time (date + hour:minute) with start and end time
    const isDateSame = currentDate === startDate && currentDate === endDate;
    const isWithinTimeFrame  = isDateSame && currentTimeOnly >= startTimeOnly && currentTimeOnly <= endTimeOnly;
  
    console.log('Is the current date the same as start and end date?', isDateSame); 
    console.log('Is the current time within the time range?', isWithinTimeFrame);
  const canShowRatingButton =
    !isUpcomingSession &&
    !isCurrentDateBefore &&
    !isStartButtonEnabled &&
    status !== BookedSession.booked &&
    Utils.compairDateGraterOrNot(start_time) &&
    !isCompleted;

  const handleClick = () => {
   updateParentState(booking_index)

  };

  const updateBookedStatusApi = (_id, booked_status) => {
    if (_id) {
      const updatePayload = {
        id: _id,
        booked_status: booked_status,
      };
      const payload = {
        ...(accountType === AccountType?.TRAINER
          ? { status: tabBook, updatePayload }
          : { updatePayload }),
      };
      dispatch(updateBookedSessionScheduledMeetingAsync(payload));
      dispatch(getScheduledMeetingDetailsAsync({ status: "upcoming" }));
    }
  };

  const sendNotifications = (data) => {
    socket?.emit(EVENTS.PUSH_NOTIFICATIONS.ON_SEND, data);
  };

  const isMeetingCanceled = () => {
    return (
      status === BookedSession.canceled || activeTabs === BookedSession.canceled
    );
  };

  const isMobileScreen = useMediaQuery('(max-width:600px)')

  return (
    <React.Fragment>
      {status !== BookedSession.canceled &&
        activeTabs !== BookedSession.canceled &&
        isMeetingDone && <h3 className="mt-1">Completed</h3>}
      {canShowRatingButton && status === BookedSession.completed ? (
        <button
          className={`btn btn-success button-effect btn-sm mr-2 my-1`}
          type="button"
          onClick={() => {
            const payload = {
              _id,
              isOpen: true,
            };
            handleAddRatingModelState(payload);
            sendNotifications({
              title: notificiationTitles.feedBackReceived,
              description:
                "Your trainee has submitted a new rating for your session.",
              senderId: trainee_info?._id,
              receiverId: trainer_info?._id,
              bookingInfo: bookingInfo,
            });
          }}
        >
          Rating
        </button>
      ) : (
        <React.Fragment>
          {!isMeetingDone && (
            <React.Fragment>
              {status !== BookedSession.canceled && (
                <React.Fragment>
                  <button
                    className={`btn btn-success button-effect btn-sm ${isMobileScreen?"mr-1": "mr-2"} btn_cancel my-1 `}
                    type="button"
                    style={{paddingLeft:isMobileScreen?"5px":"auto",paddingRight:isMobileScreen?"5px":"auto"}}
                    onClick={() => {
                      if (trainee_clips?.length > 0)
                        setSelectedClips(trainee_clips);
                      setIsOpenID(_id);
                      setIsOpen(true);
                    }}
                  >
                    Add Clip
                  </button>
                  {status === BookedSession.booked ? (
                    <button
                    className={`btn btn-dark button-effect btn-sm ${isMobileScreen?"mr-1": "mr-2"} btn_cancel my-1 `}
                    
                      type="button"
                    
                      style={{
                        cursor:
                          status === BookedSession.booked && "not-allowed",
                          paddingLeft:isMobileScreen?"5px":"auto",paddingRight:isMobileScreen?"5px":"auto"
                      }}
                      disabled={status === BookedSession.booked}
                    >
                      {BookedSession.booked}
                    </button>
                  ) : (
                    <button
                    className={`btn btn-primary button-effect btn-sm ${isMobileScreen?"mr-1": "mr-2"} btn_cancel my-1 `}
            
                      type="button"
                      style={{
                        cursor:
                          status === BookedSession.confirmed && "not-allowed",
                          paddingLeft:isMobileScreen?"5px":"auto",paddingRight:isMobileScreen?"5px":"auto"
                      }}
                      disabled={status === BookedSession.confirmed}
                    >
                      {BookedSession.confirmed}
                    </button>
                  )}
                  {isOpenID === _id &&
                  <AddClip
                    isOpen={isOpen}
                    onClose={() => {
                      setIsOpen(false);
                      dispatch(removeNewBookingData());
                    }}
                    trainer={trainer_info?.fullname}
                    selectedClips={selectedClips}
                    setSelectedClips={setSelectedClips}
                    clips={clips}
                    shareFunc={addTraineeClipInBookedSession}
                    sendNotfication={null}
                  />}
                </React.Fragment>
              )}
              {status === BookedSession.confirmed && (
                <button
                className={`btn btn-primary button-effect btn-sm ${isMobileScreen?"mr-1": "mr-2"} btn_cancel my-1 `}

                  type="button"
                  style={{
                    cursor: isWithinTimeFrame ? "pointer" : "not-allowed",
                    paddingLeft:isMobileScreen?"5px":"auto",paddingRight:isMobileScreen?"5px":"auto"
                  }}
                  disabled={!isWithinTimeFrame}
                  onClick={() => {
                    navigateToMeeting(_id)
                    sendNotifications({
                      title: notificiationTitles.sessionStrated,
                      description: `${trainee_info.fullname} has started the session. Join the session via the upcoming sessions tab in My Locker.`,
                      senderId: trainee_info?._id,
                      receiverId: trainer_info?._id,
                      bookingInfo: bookingInfo,
                    });
                  }}
                >
                  {BookedSession.start}
                </button>
              )}
              <button
                className={`btn btn-danger button-effect btn-sm ${isMobileScreen?"mr-1": "mr-2"} btn_cancel my-1 `}
                type="button"
                style={{
                  cursor:
                    status === BookedSession.canceled || isStartButtonEnabled
                      ? "not-allowed"
                      : "pointer",
                      paddingLeft:isMobileScreen?"5px":"auto",paddingRight:isMobileScreen?"5px":"auto"
                }}
                disabled={
                  status === BookedSession.canceled || isStartButtonEnabled
                }
                onClick={() => {
                  if (
                    !isStartButtonEnabled &&
                    (status === BookedSession?.booked ||
                      status === BookedSession?.confirmed)
                  ) {
                    setBookedSession({
                      ...bookedSession,
                      id: _id,
                      booked_status: BookedSession.canceled,
                    });
                    updateBookedStatusApi(_id, BookedSession.canceled);
                    sendNotifications({
                      title: notificiationTitles.sessionCancelattion,
                      description:
                        "A scheduled training session has been cancelled. Please check your calendar for details.",
                      senderId: trainee_info?._id,
                      receiverId: trainer_info?._id,
                      bookingInfo: null,
                    });
                  }
                }}
              >
                {status === BookedSession.canceled
                  ? BookedSession.canceled
                  : "Cancel"}
              </button>
            </React.Fragment>
          )}
          {isMeetingCanceled() && isMeetingDone && (
            <button
             className={`btn btn-danger button-effect btn-sm ${isMobileScreen?"mr-1": "mr-2"} btn_cancel my-1 `}
              type="button"
              style={{
                cursor:
                  status === BookedSession.canceled ? "not-allowed" : "pointer",
                  paddingLeft:isMobileScreen?"5px":"auto",paddingRight:isMobileScreen?"5px":"auto"
              }}
              disabled={isMeetingCanceled()}
            >
              {isMeetingCanceled() ? BookedSession.canceled : "Cancel"}
            </button>
          )}
        </React.Fragment>
      )}
    </React.Fragment>
  );
};

export default TraineeRenderBooking;
